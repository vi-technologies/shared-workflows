# =============================================================================
# CDK DETECT STACKS WORKFLOW
# =============================================================================
# This reusable workflow detects which CDK stacks are affected by file changes.
# It uses a configuration-based approach to map file patterns to stack names.
#
# USAGE:
#   jobs:
#     detect:
#       uses: vi-technologies/shared-workflows/.github/workflows/cdk-detect-stacks.yaml@main
#       with:
#         stack-mappings: |
#           {
#             "iac/dbs/": ["GlueDatabaseStack"],
#             "iac/s3buckets/": ["BucketsStack"],
#             "iac/container_registry/": ["ContainerRegistryStack"]
#           }
#         all-stacks: "GlueDatabaseStack BucketsStack ContainerRegistryStack"
#         entry-files: "app.py iac/app.py"
#         environment: "Production"
# =============================================================================

name: CDK Detect Stacks

on:
  workflow_call:
    inputs:
      # -----------------------------------------------------------------------
      # Stack Configuration
      # -----------------------------------------------------------------------
      stack-mappings:
        description: |
          JSON object mapping file path patterns to stack name prefixes.
          Example: {"iac/dbs/": ["GlueDatabaseStackBronze", "GlueDatabaseStackSilver"]}
        required: true
        type: string

      all-stacks:
        description: |
          Space-separated list of all stack name prefixes to deploy when entry files change.
          The environment suffix will be appended automatically.
        required: true
        type: string

      entry-files:
        description: |
          Space-separated list of entry point files that affect all stacks.
          Example: "app.py iac/app.py bin/iac-aws.ts"
        required: false
        type: string
        default: 'app.py'

      environment:
        description: |
          Environment suffix to append to stack names (e.g., "Production", "Staging").
          Set to empty string if stacks don't have environment suffixes.
        required: false
        type: string
        default: ''

      infra-paths:
        description: |
          Regex pattern to filter infrastructure files from changed files.
          Example: "^(lib/|bin/).*\\.ts$" for TypeScript or "^iac/" for Python
        required: false
        type: string
        default: '^iac/'

      working-directory:
        description: 'Working directory for git operations'
        required: false
        type: string
        default: '.'

    outputs:
      has_changes:
        description: 'Whether any stacks are affected by the changes'
        value: ${{ jobs.detect.outputs.has_changes }}
      stacks:
        description: 'Space-separated list of affected stack names'
        value: ${{ jobs.detect.outputs.stacks }}
      stacks_json:
        description: 'JSON array of affected stack names'
        value: ${{ jobs.detect.outputs.stacks_json }}

jobs:
  detect:
    name: Detect Changed Stacks
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      stacks: ${{ steps.detect.outputs.stacks }}
      stacks_json: ${{ steps.detect.outputs.stacks_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to compare

      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: ${{ github.job_workflow_sha }}
          sparse-checkout: .github/scripts
          path: _shared

      - name: Detect affected stacks
        id: detect
        env:
          STACK_MAPPINGS: ${{ inputs.stack-mappings }}
          ALL_STACKS: ${{ inputs.all-stacks }}
          ENTRY_FILES: ${{ inputs.entry-files }}
          ENVIRONMENT: ${{ inputs.environment }}
          INFRA_PATTERN: ${{ inputs.infra-paths }}
          WORKING_DIR: ${{ inputs.working-directory }}
        run: bash _shared/.github/scripts/detect-stacks.sh
