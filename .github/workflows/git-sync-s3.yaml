# =============================================================================
# GIT SYNC TO S3 WORKFLOW
# =============================================================================
# This reusable workflow syncs files from a GitHub repository folder to an S3
# bucket path — "ArgoCD-style" for files: what's in Git is what's in S3.
#
# FEATURES:
#   - Syncs a repo folder to an S3 bucket/prefix using `aws s3 sync --delete`
#   - Ensures S3 is an exact mirror of the Git source of truth
#   - Uses OIDC for secure, keyless AWS authentication
#   - Supports root bucket path (no prefix) or nested prefixes
#   - Dry-run mode to preview changes without applying
#   - Easy-to-use exclude/include pattern inputs
#
# USE CASES:
#   - Sync Airflow DAGs from Git to S3
#   - Deploy static config/data files managed in Git
#   - Any "Git as source of truth → S3" pattern
#
# USAGE:
#   jobs:
#     sync:
#       uses: vi-technologies/shared-workflows/.github/workflows/git-sync-s3.yaml@main
#       with:
#         aws-role-arn: 'arn:aws:iam::123456789012:role/GithubActionsRole'
#         github-folder-path: 'dags'
#         s3-bucket-name: 'my-airflow-bucket'
#         s3-bucket-path: 'dags'
#         exclude-patterns: '*.pyc __pycache__/* .git/*'
#         include-patterns: '*.py *.sql'
#
#   # Root bucket sync (no prefix):
#   jobs:
#     sync:
#       uses: vi-technologies/shared-workflows/.github/workflows/git-sync-s3.yaml@main
#       with:
#         aws-role-arn: 'arn:aws:iam::123456789012:role/GithubActionsRole'
#         github-folder-path: 'config'
#         s3-bucket-name: 'my-bucket'
# =============================================================================

name: Git Sync to S3

on:
  workflow_call:
    inputs:
      # -----------------------------------------------------------------------
      # AWS Configuration
      # -----------------------------------------------------------------------
      aws-role-arn:
        description: 'AWS IAM role ARN to assume (OIDC)'
        required: true
        type: string

      aws-region:
        description: 'AWS region for credentials'
        required: false
        type: string
        default: 'us-east-1'

      # -----------------------------------------------------------------------
      # S3 Configuration
      # -----------------------------------------------------------------------
      s3-bucket-name:
        description: 'S3 bucket name'
        required: true
        type: string

      s3-bucket-path:
        description: 'S3 bucket prefix/path (leave empty to sync to bucket root)'
        required: false
        type: string
        default: ''

      # -----------------------------------------------------------------------
      # Source Configuration
      # -----------------------------------------------------------------------
      github-folder-path:
        description: 'Repo folder path to sync (relative to repo root)'
        required: true
        type: string

      # -----------------------------------------------------------------------
      # Sync Options
      # -----------------------------------------------------------------------
      dry-run:
        description: 'If true, only preview changes without applying (--dryrun)'
        required: false
        type: boolean
        default: false

      exclude-patterns:
        description: 'Space-separated glob patterns to exclude (e.g., "*.pyc __pycache__/* .git/*")'
        required: false
        type: string
        default: ''

      include-patterns:
        description: 'Space-separated glob patterns to include (e.g., "*.py *.sql"). Note: include is evaluated after exclude'
        required: false
        type: string
        default: ''

      extra-args:
        description: 'Additional raw arguments to pass to aws s3 sync'
        required: false
        type: string
        default: ''

jobs:
  # ===========================================================================
  # JOB: SYNC FILES FROM GIT TO S3
  # ===========================================================================
  sync:
    name: Sync to S3
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # =======================================================================
      # SETUP
      # =======================================================================
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      # =======================================================================
      # BUILD ARGS — expand exclude/include patterns into CLI flags
      # =======================================================================
      - name: Build sync args
        id: args
        env:
          EXCLUDE_PATTERNS: ${{ inputs.exclude-patterns }}
          INCLUDE_PATTERNS: ${{ inputs.include-patterns }}
          DRY_RUN: ${{ inputs.dry-run }}
          EXTRA_ARGS: ${{ inputs.extra-args }}
        run: |
          ARGS="--delete"
          for p in $EXCLUDE_PATTERNS; do ARGS="$ARGS --exclude \"$p\""; done
          for p in $INCLUDE_PATTERNS; do ARGS="$ARGS --include \"$p\""; done
          if [ "$DRY_RUN" = "true" ]; then ARGS="$ARGS --dryrun"; fi
          if [ -n "$EXTRA_ARGS" ]; then ARGS="$ARGS $EXTRA_ARGS"; fi
          echo "flags=$ARGS" >> $GITHUB_OUTPUT

      # =======================================================================
      # SYNC — jakejarvis/s3-sync-action picks up OIDC temp creds from env
      # =======================================================================
      - name: Sync to S3
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: ${{ steps.args.outputs.flags }}
        env:
          AWS_S3_BUCKET: ${{ inputs.s3-bucket-name }}
          AWS_REGION: ${{ inputs.aws-region }}
          SOURCE_DIR: ${{ inputs.github-folder-path }}
          DEST_DIR: ${{ inputs.s3-bucket-path }}
