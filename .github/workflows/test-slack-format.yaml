name: Test Slack Format

on:
  workflow_dispatch:
    inputs:
      format_version:
        description: 'Format version to test (v1, v2, v3)'
        required: true
        default: 'v2'
        type: choice
        options:
          - v1
          - v2
          - v3

jobs:
  test-slack:
    runs-on: ubuntu-latest
    steps:
      - name: Send test Slack message
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_DEVOPS_WEBHOOK_URL }}
          FORMAT_VERSION: ${{ inputs.format_version }}
        run: |
          if [ "$FORMAT_VERSION" == "v1" ]; then
            # Original format (current)
            PAYLOAD=$(cat <<'EOF'
          {
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "ðŸ” CDK Diff Preview (PR)", "emoji": true }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Repository:*\n`iac-aws-org`" },
                  { "type": "mrkdwn", "text": "*Author:*\namitaig" }
                ]
              },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "*PR:* <https://github.com/vi-technologies/iac-aws-org/pull/199|#199 TEST: Slack format>" }
              },
              { "type": "divider" },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "ðŸ“Š *28 changes:* ðŸŸ¢ 18 add | ðŸŸ¡ 10 update | ðŸ”´ 0 destroy\n\nðŸ“¦ *Stack TestBuckets*\nðŸŸ¢ S3::Bucket slack-notification-test-bucket\nðŸŸ¡ S3::Bucket vi-engage-partners-events-test\n   â””â”€â”€ Tags: +SlackNotificationTest" }
              },
              {
                "type": "context",
                "elements": [{ "type": "mrkdwn", "text": "ðŸ”— <https://github.com|View workflow>" }]
              }
            ]
          }
          EOF
          )
          elif [ "$FORMAT_VERSION" == "v2" ]; then
            # Improved format with code blocks
            PAYLOAD=$(cat <<'EOF'
          {
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "ðŸ” CDK Diff Preview", "emoji": true }
              },
              {
                "type": "context",
                "elements": [{ "type": "mrkdwn", "text": "ðŸ“ *iac-aws-org* â€¢ ðŸ‘¤ amitaig â€¢ <https://github.com/vi-technologies/iac-aws-org/pull/199|PR #199>" }]
              },
              { "type": "divider" },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "ðŸ“Š *28 changes:*  `+18 adds`  `~10 updates`  `-0 deletes`" }
              },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "*ðŸ“¦ TestBuckets* _(staging)_\n```diff\n+ S3::Bucket       slack-notification-test-bucket\n+ S3::BucketPolicy slack-notification-test-bucket/Policy\n~ S3::Bucket       vi-engage-partners-events-test\n  â””â”€ Tags: +SlackNotificationTest\n```" }
              },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "*ðŸ“¦ AthenaResultsDataVaultViBucket* _(data-vault)_\n```diff\n+ S3::Bucket       slack-notification-test-bucket\n~ S3::Bucket       athena-results-data-vault-vi\n  â””â”€ Tags: +ParserTest\n```" }
              },
              {
                "type": "context",
                "elements": [{ "type": "mrkdwn", "text": "ðŸ”— <https://github.com|View workflow run>" }]
              }
            ]
          }
          EOF
          )
          elif [ "$FORMAT_VERSION" == "v3" ]; then
            # Compact format with attachment color
            PAYLOAD=$(cat <<'EOF'
          {
            "attachments": [
              {
                "color": "#36a64f",
                "blocks": [
                  {
                    "type": "section",
                    "text": { "type": "mrkdwn", "text": "*ðŸ” CDK Diff Preview*\n<https://github.com/vi-technologies/iac-aws-org/pull/199|iac-aws-org #199> by amitaig" }
                  },
                  {
                    "type": "section",
                    "fields": [
                      { "type": "mrkdwn", "text": "*Adds*\n`18`" },
                      { "type": "mrkdwn", "text": "*Updates*\n`10`" },
                      { "type": "mrkdwn", "text": "*Deletes*\n`0`" },
                      { "type": "mrkdwn", "text": "*Stacks*\n`8`" }
                    ]
                  },
                  { "type": "divider" },
                  {
                    "type": "section", 
                    "text": { "type": "mrkdwn", "text": "```\nðŸ“¦ TestBuckets (staging)\n  + S3::Bucket slack-notification-test-bucket\n  ~ S3::Bucket vi-engage-partners-events-test\n      â””â”€ Tags: +SlackNotificationTest\n\nðŸ“¦ AthenaResultsDataVaultViBucket (data-vault)\n  + S3::Bucket slack-notification-test-bucket\n  ~ S3::Bucket athena-results-data-vault-vi\n```" }
                  },
                  {
                    "type": "context",
                    "elements": [{ "type": "mrkdwn", "text": "<https://github.com|View workflow>" }]
                  }
                ]
              }
            ]
          }
          EOF
          )
          fi
          
          echo "Testing format: $FORMAT_VERSION"
          curl -s -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
          echo "Message sent!"
