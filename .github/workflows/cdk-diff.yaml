# =============================================================================
# CDK DIFF WORKFLOW
# =============================================================================
# This reusable workflow performs CDK diff operations on AWS CDK stacks and
# optionally runs CloudFormation drift detection. Results are posted as a
# formatted comment on the pull request.
#
# FEATURES:
#   - Runs `cdk diff` against specified stacks
#   - Supports cross-account deployments via role assumption
#   - Detects CloudFormation drift (optional)
#   - Posts detailed, formatted results to the PR
#
# SECTIONS IN THIS FILE:
#   1. Workflow Inputs          (line ~20)  - Configuration parameters
#   2. Job Setup               (line ~75)  - Environment preparation
#   3. CDK Diff & Drift        (line ~115) - Main diff/drift logic (bash)
#   4. PR Comment Generation   (line ~320) - Comment formatting (JavaScript)
# =============================================================================

name: CDK Diff

on:
  workflow_call:
    # =========================================================================
    # SECTION 1: WORKFLOW INPUTS
    # =========================================================================
    # All configurable parameters for the workflow. Only `aws-role-arn` and
    # `stacks` are required.
    # =========================================================================
    inputs:
      # -----------------------------------------------------------------------
      # Build Environment Configuration
      # -----------------------------------------------------------------------
      working-directory:
        description: 'Working directory for CDK commands'
        required: false
        type: string
        default: '.'

      python-version:
        description: 'Python version (for Python CDK apps)'
        required: false
        type: string
        default: ''

      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'

      install-command:
        description: 'Command to install dependencies'
        required: false
        type: string
        default: 'npm ci'

      # -----------------------------------------------------------------------
      # AWS Configuration
      # -----------------------------------------------------------------------
      aws-region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'

      aws-role-arn:
        description: 'AWS IAM role ARN to assume'
        required: true
        type: string

      # -----------------------------------------------------------------------
      # CDK Diff Configuration
      # -----------------------------------------------------------------------
      stacks:
        description: 'Space-separated list of stack names to diff'
        required: true
        type: string

      enable-drift-detection:
        description: 'Whether to run drift detection'
        required: false
        type: boolean
        default: true

      # -----------------------------------------------------------------------
      # Display Configuration
      # -----------------------------------------------------------------------
      account-names:
        description: 'JSON map of account IDs to friendly names (e.g. {"123456789012": "production"})'
        required: false
        type: string
        default: '{}'

      pr-number:
        description: 'Pull request number'
        required: false
        type: number
        default: 0

      # -----------------------------------------------------------------------
      # Slack Notification Configuration
      # -----------------------------------------------------------------------
      slack-notify-label:
        description: 'PR label that triggers Slack notification (e.g., "slack-notify" or "deploy-preview")'
        required: false
        type: string
        default: 'slack-notify'

      slack-channel-name:
        description: 'Slack channel name (for display purposes)'
        required: false
        type: string
        default: 'devops'

    secrets:
      slack-webhook-url:
        description: 'Slack webhook URL for notifications (required if using slack-notify label)'
        required: false

jobs:
  diff:
    name: CDK Diff
    runs-on: ubuntu-latest
    permissions:
      id-token: write      # Required for OIDC authentication with AWS
      contents: read       # Required to checkout code
      pull-requests: write # Required to post PR comments
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      # =======================================================================
      # SECTION 2: JOB SETUP
      # =======================================================================
      # Prepares the environment: checkout code, setup runtimes, install deps,
      # configure AWS credentials, and synthesize the CDK app.
      # =======================================================================

      # -----------------------------------------------------------------------
      # 2.1 Source Code Checkout
      # -----------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for some CDK operations

      # -----------------------------------------------------------------------
      # 2.2 Runtime Setup
      # -----------------------------------------------------------------------
      - name: Setup Python
        if: inputs.python-version != ''
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      # -----------------------------------------------------------------------
      # 2.3 Dependency Installation
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: ${{ inputs.install-command }}

      - name: Install AWS CDK CLI
        run: npm install -g aws-cdk

      # -----------------------------------------------------------------------
      # 2.4 AWS Authentication
      # -----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      # -----------------------------------------------------------------------
      # 2.5 CDK Synthesis
      # -----------------------------------------------------------------------
      - name: Synth CDK app
        run: npx cdk synth --quiet --output cdk.out

      # =======================================================================
      # SECTION 3: CDK DIFF & DRIFT DETECTION
      # =======================================================================
      # This is the main logic that:
      #   - Iterates through each stack
      #   - Handles cross-account role assumption
      #   - Runs `cdk diff` to detect changes
      #   - Runs CloudFormation drift detection (if enabled)
      #   - Aggregates results into JSON output
      #
      # HELPER FUNCTIONS:
      #   - get_stack_account()    : Gets AWS account ID from CDK manifest
      #   - get_account_name()     : Maps account ID to friendly name
      #   - get_cf_stack_name()    : Gets CloudFormation stack name from CDK
      #   - restore_credentials()  : Restores original AWS credentials
      #   - assume_target_role()   : Assumes CDK lookup role in target account
      # =======================================================================
      - name: Run CDK Diff and Drift Detection
        id: diff
        env:
          STACKS: ${{ inputs.stacks }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
          AWS_REGION: ${{ inputs.aws-region }}
          ACCOUNT_NAMES: ${{ inputs.account-names }}
        run: |
          echo "=== Starting CDK Diff ==="
          
          # ---------------------------------------------------------------------
          # 3.1 Initialize: Capture Current Account & Store Original Credentials
          # ---------------------------------------------------------------------
          # We need to save original credentials so we can restore them after
          # assuming roles in other accounts (for cross-account deployments).
          # ---------------------------------------------------------------------
          CURRENT_ACCOUNT=$(aws sts get-caller-identity --query 'Account' --output text)
          echo "Current AWS account: $CURRENT_ACCOUNT"
          
          ORIGINAL_ACCESS_KEY="$AWS_ACCESS_KEY_ID"
          ORIGINAL_SECRET_KEY="$AWS_SECRET_ACCESS_KEY"
          ORIGINAL_SESSION_TOKEN="$AWS_SESSION_TOKEN"
          
          # Results array - will hold diff results for all stacks
          RESULTS="[]"
          
          # ---------------------------------------------------------------------
          # 3.2 Helper Function: get_stack_account
          # ---------------------------------------------------------------------
          # Extracts the target AWS account ID for a stack from the CDK manifest.
          # Falls back to current account if not found.
          #
          # Args: $1 = CDK stack name
          # Returns: AWS account ID (12-digit number)
          # ---------------------------------------------------------------------
          get_stack_account() {
            local stack_name="$1"
            if [ -f "cdk.out/manifest.json" ]; then
              # Extract account from environment field: "aws://123456789012/us-east-1"
              local account=$(jq -r ".artifacts[\"$stack_name\"].environment // \"\"" cdk.out/manifest.json 2>/dev/null | sed -E 's/aws:\/\/([0-9]+)\/.*/\1/')
              if [ -n "$account" ] && [ "$account" != "null" ] && [ "$account" != "" ]; then
                echo "$account"
                return
              fi
            fi
            echo "$CURRENT_ACCOUNT"
          }
          
          # ---------------------------------------------------------------------
          # 3.3 Helper Function: get_account_name
          # ---------------------------------------------------------------------
          # Maps an AWS account ID to a friendly name using the ACCOUNT_NAMES
          # input parameter. Returns the account ID if no mapping exists.
          #
          # Args: $1 = AWS account ID
          # Returns: Friendly name or account ID
          # ---------------------------------------------------------------------
          get_account_name() {
            local account_id="$1"
            local name=$(echo "$ACCOUNT_NAMES" | jq -r ".[\"$account_id\"] // \"\"" 2>/dev/null)
            if [ -n "$name" ] && [ "$name" != "null" ] && [ "$name" != "" ]; then
              echo "$name"
            else
              echo "$account_id"
            fi
          }
          
          # ---------------------------------------------------------------------
          # 3.4 Helper Function: get_cf_stack_name
          # ---------------------------------------------------------------------
          # Gets the actual CloudFormation stack name from the CDK manifest.
          # CDK allows overriding the CF stack name, so it may differ from the
          # CDK construct name.
          #
          # Args: $1 = CDK stack name
          # Returns: CloudFormation stack name
          # ---------------------------------------------------------------------
          get_cf_stack_name() {
            local cdk_stack="$1"
            if [ -f "cdk.out/manifest.json" ]; then
              local cf_name=$(jq -r ".artifacts[\"$cdk_stack\"].properties.stackName // \"$cdk_stack\"" cdk.out/manifest.json 2>/dev/null)
              if [ -n "$cf_name" ] && [ "$cf_name" != "null" ]; then
                echo "$cf_name"
              else
                echo "$cdk_stack"
              fi
            else
              echo "$cdk_stack"
            fi
          }
          
          # ---------------------------------------------------------------------
          # 3.5 Helper Function: restore_credentials
          # ---------------------------------------------------------------------
          # Restores the original AWS credentials after assuming a cross-account
          # role. Called after processing each stack.
          # ---------------------------------------------------------------------
          restore_credentials() {
            export AWS_ACCESS_KEY_ID="$ORIGINAL_ACCESS_KEY"
            export AWS_SECRET_ACCESS_KEY="$ORIGINAL_SECRET_KEY"
            export AWS_SESSION_TOKEN="$ORIGINAL_SESSION_TOKEN"
          }
          
          # ---------------------------------------------------------------------
          # 3.6 Helper Function: assume_target_role
          # ---------------------------------------------------------------------
          # Assumes the CDK lookup role in a target account for cross-account
          # operations. CDK creates this role during bootstrap.
          #
          # Role pattern: arn:aws:iam::{account}:role/cdk-hnb659fds-lookup-role-{account}-{region}
          #
          # Args: $1 = Target AWS account ID
          # Returns: 0 on success, 1 on failure
          # ---------------------------------------------------------------------
          assume_target_role() {
            local target_account="$1"
            local region="$AWS_REGION"
            local lookup_role="arn:aws:iam::${target_account}:role/cdk-hnb659fds-lookup-role-${target_account}-${region}"
            
            local creds=$(aws sts assume-role \
              --role-arn "$lookup_role" \
              --role-session-name "cdk-diff-session" \
              --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
              --output text 2>/dev/null) || true
            
            if [ -n "$creds" ]; then
              export AWS_ACCESS_KEY_ID=$(echo "$creds" | cut -f1)
              export AWS_SECRET_ACCESS_KEY=$(echo "$creds" | cut -f2)
              export AWS_SESSION_TOKEN=$(echo "$creds" | cut -f3)
              return 0
            fi
            return 1
          }
          
          # =====================================================================
          # 3.7 Main Loop: Process Each Stack
          # =====================================================================
          # For each stack:
          #   1. Determine target account and CF stack name
          #   2. Assume cross-account role if needed
          #   3. Run cdk diff
          #   4. Count changes (adds, updates, destroys, replaces)
          #   5. Run drift detection (if enabled)
          #   6. Aggregate results
          # =====================================================================
          for STACK in $STACKS; do
            echo ""
            echo "=== Processing stack: $STACK ==="
            
            # -------------------------------------------------------------------
            # 3.7.1 Resolve Stack Metadata
            # -------------------------------------------------------------------
            TARGET_ACCOUNT=$(get_stack_account "$STACK")
            CF_STACK_NAME=$(get_cf_stack_name "$STACK")
            ACCOUNT_NAME=$(get_account_name "$TARGET_ACCOUNT")
            
            echo "Target account: $TARGET_ACCOUNT ($ACCOUNT_NAME)"
            echo "CloudFormation stack name: $CF_STACK_NAME"
            
            # -------------------------------------------------------------------
            # 3.7.2 Cross-Account Role Assumption
            # -------------------------------------------------------------------
            # If the stack deploys to a different account, assume the CDK lookup
            # role in that account to perform drift detection.
            # -------------------------------------------------------------------
            if [ "$TARGET_ACCOUNT" != "$CURRENT_ACCOUNT" ]; then
              assume_target_role "$TARGET_ACCOUNT" || true
            fi
            
            # -------------------------------------------------------------------
            # 3.7.3 Run CDK Diff
            # -------------------------------------------------------------------
            # Execute cdk diff and capture output. The diff shows:
            #   [+] = Resources to be added
            #   [~] = Resources to be modified
            #   [-] = Resources to be removed
            # -------------------------------------------------------------------
            echo "Running cdk diff..."
            DIFF_OUTPUT=$(npx cdk diff "$STACK" --no-color 2>&1) || true
            
            # Check if stack exists (new stacks show "does not exist" message)
            STACK_EXISTS="true"
            if echo "$DIFF_OUTPUT" | grep -q "does not exist\|has not been deployed"; then
              STACK_EXISTS="false"
            fi
            
            # -------------------------------------------------------------------
            # 3.7.4 Count Resource Changes
            # -------------------------------------------------------------------
            # Parse the diff output to count different types of changes.
            # We look for AWS:: prefixed lines to count actual resource changes.
            # -------------------------------------------------------------------
            ADDS=$(echo "$DIFF_OUTPUT" | grep -E '\[\+\] AWS::' | wc -l | tr -d ' ')
            UPDATES=$(echo "$DIFF_OUTPUT" | grep -E '\[~\] AWS::' | wc -l | tr -d ' ')
            DESTROYS=$(echo "$DIFF_OUTPUT" | grep -E '\[-\] AWS::' | wc -l | tr -d ' ')
            REPLACES=$(echo "$DIFF_OUTPUT" | grep -i 'replace' | wc -l | tr -d ' ')
            
            # Ensure numbers are valid (default to 0 if parsing failed)
            ADDS=${ADDS:-0}
            UPDATES=${UPDATES:-0}
            DESTROYS=${DESTROYS:-0}
            REPLACES=${REPLACES:-0}
            [[ "$ADDS" =~ ^[0-9]+$ ]] || ADDS=0
            [[ "$UPDATES" =~ ^[0-9]+$ ]] || UPDATES=0
            [[ "$DESTROYS" =~ ^[0-9]+$ ]] || DESTROYS=0
            [[ "$REPLACES" =~ ^[0-9]+$ ]] || REPLACES=0
            
            echo "Change counts: adds=$ADDS, updates=$UPDATES, destroys=$DESTROYS, replaces=$REPLACES"
            
            # -------------------------------------------------------------------
            # 3.7.5 Drift Detection
            # -------------------------------------------------------------------
            # If enabled, detect configuration drift between the CloudFormation
            # template and actual deployed resources. This helps identify manual
            # changes made outside of CDK/CloudFormation.
            #
            # Drift statuses:
            #   - IN_SYNC: No drift detected
            #   - DRIFTED: Resources have drifted from template
            #   - NOT_SUPPORTED: Some resources don't support drift detection
            # -------------------------------------------------------------------
            DRIFT_STATUS="‚è≠Ô∏è Skipped"
            DRIFT_DETAILS=""
            
            if [ "$ENABLE_DRIFT" = "true" ]; then
              # Check if stack is deployed before running drift detection
              if aws cloudformation describe-stacks --stack-name "$CF_STACK_NAME" >/dev/null 2>&1; then
                # Initiate drift detection
                DRIFT_ID=$(aws cloudformation detect-stack-drift --stack-name "$CF_STACK_NAME" --query 'StackDriftDetectionId' --output text 2>/dev/null) || true
                
                if [ -n "$DRIFT_ID" ] && [ "$DRIFT_ID" != "None" ]; then
                  # Poll for drift detection completion (max 60 seconds = 12 * 5s)
                  for i in {1..12}; do
                    sleep 5
                    DRIFT_CHECK=$(aws cloudformation describe-stack-drift-detection-status \
                      --stack-drift-detection-id "$DRIFT_ID" \
                      --query 'DetectionStatus' --output text 2>/dev/null) || echo "FAILED"
                    
                    if [ "$DRIFT_CHECK" = "DETECTION_COMPLETE" ]; then
                      # Get final drift status
                      DRIFT_RESULT=$(aws cloudformation describe-stack-drift-detection-status \
                        --stack-drift-detection-id "$DRIFT_ID" \
                        --query 'StackDriftStatus' --output text 2>/dev/null) || echo "UNKNOWN"
                      
                      if [ "$DRIFT_RESULT" = "IN_SYNC" ]; then
                        DRIFT_STATUS="‚úÖ In Sync"
                      elif [ "$DRIFT_RESULT" = "DRIFTED" ]; then
                        DRIFT_STATUS="üö® Drifted"
                        # Get detailed drift information for reporting
                        DRIFT_DETAILS=$(aws cloudformation describe-stack-resource-drifts \
                          --stack-name "$CF_STACK_NAME" \
                          --stack-resource-drift-status-filters MODIFIED DELETED \
                          --query 'StackResourceDrifts[].{Type:ResourceType,Id:LogicalResourceId,Status:StackResourceDriftStatus,Props:PropertyDifferences}' \
                          --output json 2>/dev/null) || echo "[]"
                      else
                        DRIFT_STATUS="‚ö†Ô∏è $DRIFT_RESULT"
                      fi
                      break
                    elif [ "$DRIFT_CHECK" = "DETECTION_FAILED" ]; then
                      DRIFT_STATUS="‚ö†Ô∏è Not Supported"
                      break
                    fi
                  done
                else
                  DRIFT_STATUS="‚ö†Ô∏è Not Supported"
                fi
              else
                DRIFT_STATUS="üÜï Not Deployed"
              fi
            fi
            
            # Restore original credentials for next iteration
            restore_credentials
            
            # -------------------------------------------------------------------
            # 3.7.6 Clean & Aggregate Results
            # -------------------------------------------------------------------
            # Remove CDK notices/warnings from diff output and build JSON result.
            # -------------------------------------------------------------------
            CLEAN_DIFF=$(echo "$DIFF_OUTPUT" | grep -v "^Notice:" | grep -v "^\*\*\*" | grep -v "newer version" | grep -v "Please upgrade")
            
            # Ensure drift details is valid JSON
            if [ -z "$DRIFT_DETAILS" ]; then
              DRIFT_DETAILS_ESCAPED="[]"
            else
              DRIFT_DETAILS_ESCAPED=$(echo "$DRIFT_DETAILS" | jq -c '.' 2>/dev/null || echo "[]")
            fi
            
            # Build JSON result object for this stack
            RESULT=$(jq -n \
              --arg stack "$STACK" \
              --argjson adds "$ADDS" \
              --argjson updates "$UPDATES" \
              --argjson destroys "$DESTROYS" \
              --argjson replaces "$REPLACES" \
              --arg drift "$DRIFT_STATUS" \
              --argjson drift_details "$DRIFT_DETAILS_ESCAPED" \
              --arg diff "$CLEAN_DIFF" \
              --arg account_name "$ACCOUNT_NAME" \
              --arg stack_exists "$STACK_EXISTS" \
              '{stack: $stack, adds: $adds, updates: $updates, destroys: $destroys, replaces: $replaces, drift: $drift, drift_details: $drift_details, diff: $diff, account_name: $account_name, stack_exists: $stack_exists}')
            
            # Append to results array
            RESULTS=$(echo "$RESULTS" | jq --argjson result "$RESULT" '. + [$result]')
          done
          
          # Output results for next step
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # =======================================================================
      # SECTION 4: PR COMMENT GENERATION
      # =======================================================================
      # This JavaScript step formats the diff results into a readable PR comment.
      #
      # SUBSECTIONS:
      #   4.1 parseDiffOutput()  - Parses CDK diff text into structured data
      #   4.2 Stack Sections     - Generates markdown for each stack
      #   4.3 Summary Line       - Creates the summary header
      #   4.4 Comment Posting    - Creates or updates the PR comment
      #
      # OUTPUT FORMAT:
      #   - Each resource change is shown with property-level diffs
      #   - Drift details are shown in tables
      #   - Collapsible sections for each stack
      # =======================================================================
      - name: Post PR Comment
        uses: actions/github-script@v7
        env:
          RESULTS: ${{ steps.diff.outputs.results }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
          PR_NUMBER: ${{ inputs.pr-number }}
        with:
          script: |
            const results = JSON.parse(process.env.RESULTS || '[]');
            const enableDrift = process.env.ENABLE_DRIFT === 'true';
            
            // =================================================================
            // 4.1 DIFF PARSER FUNCTION
            // =================================================================
            // Parses CDK diff output into structured resource changes.
            //
            // CDK diff format examples:
            //   [+] AWS::S3::Bucket MyBucket
            //   [~] AWS::Lambda::Function MyFunction
            //   [-] AWS::IAM::Role OldRole
            //
            // Property changes appear as:
            //   ‚îî‚îÄ‚îÄ [~] Property
            //       ‚îî‚îÄ‚îÄ [-] old_value
            //       ‚îî‚îÄ‚îÄ [+] new_value
            //
            // Or unified diff format for complex changes:
            //   @@ -1,3 +1,4 @@
            //   [-] removed line
            //   [+] added line
            // =================================================================
            function parseDiffOutput(diff) {
              const resources = [];
              if (!diff) return resources;
              
              const lines = diff.split('\n');
              
              // State tracking variables
              let currentResource = null;   // Current resource being parsed
              let currentProperty = null;   // Current property being parsed
              let inUnifiedDiff = false;    // Whether we're in unified diff mode
              let removedLines = [];        // Lines removed (accumulated)
              let addedLines = [];          // Lines added (accumulated)
              
              // Helper to format multi-line values - filter out JSON structure noise
              function formatValue(lines) {
                if (lines.length === 0) return null;
                if (lines.length === 1) return lines[0];
                
                // Filter out pure JSON structure characters (braces, brackets, commas only)
                const meaningful = lines.filter(l => {
                  const cleaned = l.replace(/[{}\[\],]/g, '').trim();
                  return cleaned.length > 0;
                });
                
                const toJoin = meaningful.length > 0 ? meaningful : lines;
                return toJoin.join(' ').replace(/\s+/g, ' ').trim();
              }
              
              // Helper to save current property to current resource
              function saveCurrentProperty() {
                if (!currentResource || !currentProperty) return;
                if (removedLines.length > 0 || addedLines.length > 0) {
                  currentResource.properties.push({
                    name: currentProperty,
                    oldValue: formatValue(removedLines),
                    newValue: formatValue(addedLines),
                    isUnifiedDiff: inUnifiedDiff
                  });
                }
              }
              
              for (const line of lines) {
                // ---------------------------------------------------------
                // 4.1.1 Match Resource Lines
                // ---------------------------------------------------------
                // Format: [+~-] AWS::Type::Name ConstructPath LogicalId
                // ---------------------------------------------------------
                const resourceMatch = line.match(/\[([+~-])\]\s+(AWS::\S+)\s+(.+)/);
                if (resourceMatch) {
                  // Save previous property and resource if exists
                  saveCurrentProperty();
                  if (currentResource) {
                    resources.push(currentResource);
                  }
                  
                  // Parse new resource
                  const [, action, type, rest] = resourceMatch;
                  const id = rest.trim().split(/\s+/).pop();
                  currentResource = {
                    action: action === '+' ? 'Add' : action === '-' ? 'Remove' : 'Modify',
                    type: type.replace('AWS::', ''),
                    id,
                    replace: line.toLowerCase().includes('replace'),
                    properties: []
                  };
                  
                  // Reset state for new resource
                  currentProperty = null;
                  inUnifiedDiff = false;
                  removedLines = [];
                  addedLines = [];
                  continue;
                }
                
                if (!currentResource) continue;
                
                // ---------------------------------------------------------
                // 4.1.2 Match Property Lines
                // ---------------------------------------------------------
                // CDK diff formats for property changes:
                //   ‚îî‚îÄ‚îÄ [~] PropertyName    (modification)
                //   ‚îî‚îÄ‚îÄ [+] PropertyName    (addition - new property)
                //   ‚îî‚îÄ‚îÄ [-] PropertyName    (removal)
                //
                // Property names are alphanumeric identifiers (e.g., Tags, 
                // BucketName, etc). They don't start with {, [, or ".
                // This distinguishes them from value lines.
                // ---------------------------------------------------------
                const propMatch = line.match(/[‚îî‚îú]\s*‚îÄ\s*\[([+~-])\]\s+([A-Za-z][A-Za-z0-9_]*)/);
                if (propMatch) {
                  // Save previous property if exists
                  saveCurrentProperty();
                  
                  // Start tracking new property
                  const propAction = propMatch[1];
                  currentProperty = propMatch[2];
                  inUnifiedDiff = false;
                  removedLines = [];
                  addedLines = [];
                  
                  // For added properties [+], we expect only added values
                  // For removed properties [-], we expect only removed values
                  // For modified properties [~], we expect both
                  continue;
                }
                
                // ---------------------------------------------------------
                // 4.1.3 Handle Unified Diff Format
                // ---------------------------------------------------------
                // Unified diff marker: @@ -x,y +a,b @@
                // ---------------------------------------------------------
                if (line.match(/@@ -\d+,\d+ \+\d+,\d+ @@/) && currentProperty) {
                  inUnifiedDiff = true;
                  removedLines = [];
                  addedLines = [];
                  continue;
                }
                
                // ---------------------------------------------------------
                // 4.1.4 Handle Property Value Changes
                // ---------------------------------------------------------
                // CDK diff value formats:
                //   ‚îî‚îÄ‚îÄ [-] old_value       (explicit removal marker)
                //   ‚îî‚îÄ‚îÄ [+] new_value       (explicit addition marker)
                //   ‚îî‚îÄ‚îÄ [value]             (implicit value, typically for adds)
                //
                // The implicit format is used when the value itself contains
                // the JSON, like: ‚îî‚îÄ‚îÄ [{"Key":"Name","Value":"test"}]
                // ---------------------------------------------------------
                if (currentProperty) {
                  const rmMatch = line.match(/\[-\]\s+(.+)/);
                  if (rmMatch) {
                    removedLines.push(rmMatch[1].trim());
                    continue;
                  }
                  
                  const addMatch = line.match(/\[\+\]\s+(.+)/);
                  if (addMatch) {
                    addedLines.push(addMatch[1].trim());
                    continue;
                  }
                  
                  // Handle implicit value lines (tree characters followed by value)
                  // Format: ‚îî‚îÄ‚îÄ [{"Key":"Name","Value":"test"}]
                  // This happens when the value is shown directly without [+]/[-]
                  const implicitValueMatch = line.match(/^\s*[‚îî‚îú‚îÇ\s]*‚îÄ?\s*(\[.+\]|\{.+\}|".+"|\d+|true|false|null)\s*$/);
                  if (implicitValueMatch) {
                    // Treat implicit values as additions (new values being set)
                    addedLines.push(implicitValueMatch[1].trim());
                    continue;
                  }
                  
                  // Context line in unified diff
                  if (inUnifiedDiff && line.match(/\[ \]/)) continue;
                }
              }
              
              // ---------------------------------------------------------
              // 4.1.5 Save Last Resource
              // ---------------------------------------------------------
              saveCurrentProperty();
              if (currentResource) {
                resources.push(currentResource);
              }
              
              return resources;
            }
            
            // =================================================================
            // 4.2 GENERATE STACK SECTIONS
            // =================================================================
            // Creates markdown for each stack with:
            //   - Stack header with account info
            //   - Resource changes with property diffs
            //   - Drift status and details
            // =================================================================
            const stackSections = results.map(r => {
              const hasChanges = r.adds + r.updates + r.destroys + r.replaces > 0;
              
              // ---------------------------------------------------------------
              // 4.2.1 Stack Header
              // ---------------------------------------------------------------
              let header = `### üì¶ ${r.stack}`;
              header += ` _(${r.account_name})_`;
              
              let content = '';
              
              // ---------------------------------------------------------------
              // 4.2.2 Stack Content Based on State
              // ---------------------------------------------------------------
              if (r.stack_exists === 'false') {
                // New stack - not yet deployed
                content = `\n\nüÜï **New Stack** - ${r.adds} resources will be created\n`;
              } else if (!hasChanges) {
                // No changes detected
                content = '\n\n‚úÖ No changes\n';
              } else {
                // Has changes - parse and display them
                const resources = parseDiffOutput(r.diff);
                
                if (resources.length > 0) {
                  // -------------------------------------------------------------
                  // 4.2.3 Format Each Resource Change
                  // -------------------------------------------------------------
                  let hasAnyProperties = false;
                  for (const res of resources) {
                    // Determine icon based on action type
                    let icon;
                    if (res.replace) {
                      icon = 'üü†';  // Replace (destroy + create)
                    } else if (res.action === 'Add') {
                      icon = 'üü¢';  // Add
                    } else if (res.action === 'Modify') {
                      icon = 'üü°';  // Modify/Update
                    } else {
                      icon = 'üî¥';  // Remove/Destroy
                    }
                    
                    const actionText = res.replace ? 'Replace' : res.action === 'Modify' ? 'Update' : res.action;
                    content += `\n\n**\`${res.id}\`** (\`${res.type}\`) ${icon} ${actionText}\n`;
                    
                    // -------------------------------------------------------------
                    // 4.2.4 Property Changes Table
                    // -------------------------------------------------------------
                    if (res.properties.length > 0) {
                      hasAnyProperties = true;
                      content += '| Property | Current | New |\n|----------|---------|-----|\n';
                      for (const prop of res.properties) {
                        let oldVal, newVal;
                        if (prop.isUnifiedDiff) {
                          // Unified diff: show full values
                          oldVal = prop.oldValue ? `\`${prop.oldValue.replace(/\n/g, ' ')}\`` : '_(none)_';
                          newVal = prop.newValue ? `\`${prop.newValue.replace(/\n/g, ' ')}\`` : '_(removed)_';
                        } else {
                          // Simple change
                          oldVal = prop.oldValue != null ? `\`${prop.oldValue}\`` : '_(not set)_';
                          newVal = prop.newValue != null ? `\`${prop.newValue}\`` : '_(removed)_';
                        }
                        content += `| \`${prop.name}\` | ${oldVal} | ${newVal} |\n`;
                      }
                    }
                  }
                  
                  // If resources were found but no properties parsed, show raw diff
                  if (!hasAnyProperties && r.diff) {
                    content += '\n<details><summary>View raw diff</summary>\n\n```\n';
                    content += r.diff;
                    content += '\n```\n</details>\n';
                  }
                } else if (hasChanges) {
                  // -------------------------------------------------------------
                  // 4.2.5 Fallback: Raw Diff Display
                  // -------------------------------------------------------------
                  // If parsing failed but changes exist, show raw diff
                  content += '\n\n<details><summary>View raw diff</summary>\n\n```\n';
                  content += r.diff || 'No diff output';
                  content += '\n```\n</details>\n';
                }
              }
              
              // ---------------------------------------------------------------
              // 4.2.6 Drift Section
              // ---------------------------------------------------------------
              if (enableDrift) {
                content += `\n**Drift:** ${r.drift}`;
                
                // Show drift details if resources have drifted
                if (r.drift.includes('Drifted') && r.drift_details && r.drift_details.length > 0) {
                  for (const d of r.drift_details.slice(0, 15)) {  // Limit to 15 resources
                    content += `\n\n**\`${d.Id}\`** (\`${d.Type.replace('AWS::', '')}\`)\n`;
                    
                    if (d.Props && d.Props.length > 0) {
                      // Show property differences table
                      content += '| Property | Expected | Actual |\n|----------|----------|--------|\n';
                      for (const p of d.Props) {
                        const path = p.PropertyPath || 'unknown';
                        const expected = p.ExpectedValue != null ? String(p.ExpectedValue) : '_(not set)_';
                        const actual = p.ActualValue != null ? String(p.ActualValue) : '_(not set)_';
                        content += `| \`${path}\` | \`${expected}\` | \`${actual}\` |\n`;
                      }
                    } else {
                      content += '_No property details available_\n';
                    }
                  }
                }
              }
              
              // Wrap in collapsible details element
              return `<details open>\n<summary>${header}</summary>\n${content}\n</details>`;
            }).join('\n\n');
            
            // =================================================================
            // 4.3 CALCULATE TOTALS & BUILD SUMMARY
            // =================================================================
            // Recalculate totals from parsed resources (more accurate than grep)
            // =================================================================
            let totalAdds = 0, totalUpdates = 0, totalDestroys = 0;
            for (const r of results) {
              const resources = parseDiffOutput(r.diff);
              for (const res of resources) {
                if (res.action === 'Add') totalAdds++;
                else if (res.action === 'Modify') totalUpdates++;
                else if (res.action === 'Remove') totalDestroys++;
              }
            }
            
            const totalChanges = totalAdds + totalUpdates + totalDestroys;
            
            // Build summary line
            let summaryLine = totalChanges === 0 
              ? '‚úÖ **No infrastructure changes**'
              : `**${totalChanges} resource changes:** üü¢ ${totalAdds} add | üü° ${totalUpdates} update | üî¥ ${totalDestroys} destroy`;
            
            // Add drift warning if detected
            const hasDrift = results.some(r => r.drift.includes('Drifted'));
            if (enableDrift && hasDrift) {
              summaryLine += ' | üö® **Drift detected**';
            }
            
            // =================================================================
            // 4.4 BUILD FINAL COMMENT BODY
            // =================================================================
            const body = [
              '## üèóÔ∏è CDK Diff',
              '',
              summaryLine,
              '',
              stackSections,
              '',
              '---',
              `<sub>Generated at ${new Date().toISOString()} from commit <code>${context.sha.substring(0, 7)}</code></sub>`
            ].join('\n');

            // =================================================================
            // 4.5 POST OR UPDATE PR COMMENT
            // =================================================================
            // Finds existing CDK Diff comment and updates it, or creates new one.
            // =================================================================
            try {
              // Get PR number from env (passed from caller) or context
              const envPrNumber = parseInt(process.env.PR_NUMBER, 10);
              const prNumber = envPrNumber > 0 ? envPrNumber : (context.payload.pull_request?.number || context.issue?.number);
              
              if (!prNumber) {
                console.log('No PR number found');
                console.log('PR_NUMBER env:', process.env.PR_NUMBER);
                console.log('Context issue:', context.issue);
                return;
              }
              
              console.log(`Posting comment to PR #${prNumber}`);
              
              // ---------------------------------------------------------------
              // 4.5.1 Find Existing Comment
              // ---------------------------------------------------------------
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });
              
              // Look for our marker to find existing CDK Diff comment
              const botComment = comments.find(c => c.body && c.body.includes('## üèóÔ∏è CDK Diff'));
              
              // ---------------------------------------------------------------
              // 4.5.2 Create or Update Comment
              // ---------------------------------------------------------------
              if (botComment) {
                console.log(`Updating existing comment ${botComment.id}`);
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body
                });
              } else {
                console.log('Creating new comment');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body
                });
              }
              console.log('Comment posted successfully');
            } catch (error) {
              console.error('Error posting comment:', error.message);
              console.error('Stack:', error.stack);
              throw error;
            }

      # =======================================================================
      # SECTION 5: SLACK NOTIFICATION (LABEL-TRIGGERED)
      # =======================================================================
      # Sends a Slack notification when the PR has the configured label.
      # This allows teams to get deployment-like visibility for important PRs.
      # =======================================================================
      - name: Check for Slack notify label and send notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack-webhook-url }}
          SLACK_LABEL: ${{ inputs.slack-notify-label }}
          SLACK_CHANNEL: ${{ inputs.slack-channel-name }}
          DIFF_RESULTS: ${{ steps.diff.outputs.results }}
          PR_NUMBER: ${{ inputs.pr-number }}
          STACKS: ${{ inputs.stacks }}
          ACCOUNT_NAMES: ${{ inputs.account-names }}
        uses: actions/github-script@v7
        with:
          script: |
            // =================================================================
            // 5.1 Check prerequisites
            // =================================================================
            if (!process.env.SLACK_WEBHOOK_URL) {
              console.log('No Slack webhook URL configured, skipping notification');
              return;
            }
            
            const envPrNumber = parseInt(process.env.PR_NUMBER, 10);
            const prNumber = envPrNumber > 0 ? envPrNumber : (context.payload.pull_request?.number || context.issue?.number);
            
            if (!prNumber) {
              console.log('No PR number found, skipping Slack notification');
              return;
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            const slackLabel = process.env.SLACK_LABEL || 'slack-notify';
            const hasLabel = pr.labels.some(label => label.name === slackLabel);
            
            if (!hasLabel) {
              console.log(`PR #${prNumber} does not have "${slackLabel}" label, skipping Slack notification`);
              return;
            }
            
            console.log(`PR #${prNumber} has "${slackLabel}" label, sending Slack notification`);
            
            // =================================================================
            // 5.2 Parse diff results and build Slack message
            // =================================================================
            const results = JSON.parse(process.env.DIFF_RESULTS || '[]');
            const repo = context.repo.repo;
            const actor = context.actor;
            const prTitle = pr.title;
            const prUrl = pr.html_url;
            const stacks = process.env.STACKS || '';
            const accountNames = JSON.parse(process.env.ACCOUNT_NAMES || '{}');
            
            // Count changes across all stacks and build stack details
            let totalAdds = 0, totalUpdates = 0, totalDestroys = 0;
            const stackData = {}; // { stackName: { account, region, resources: [{type, name, icon, properties}] } }
            
            for (const result of results) {
              const stackName = result.stack;
              if (!stackData[stackName]) {
                // Extract account from result if available
                const accountMatch = result.diff?.match(/Account:\s*(\d+)/);
                const regionMatch = result.diff?.match(/Region:\s*([\w-]+)/);
                stackData[stackName] = {
                  account: result.account || (accountMatch ? accountMatch[1] : null),
                  region: result.region || (regionMatch ? regionMatch[1] : 'us-east-1'),
                  resources: []
                };
              }
              
              if (result.diff) {
                // Count changes
                const adds = (result.diff.match(/\[\+\]\s*AWS::/g) || []).length;
                const updates = (result.diff.match(/\[~\]\s*AWS::/g) || []).length;
                const destroys = (result.diff.match(/\[-\]\s*AWS::/g) || []).length;
                totalAdds += adds;
                totalUpdates += updates;
                totalDestroys += destroys;
                
                // Parse resource changes with properties
                const lines = result.diff.split('\n');
                let currentResource = null;
                
                for (const line of lines) {
                  // Match resource lines: [+], [~], [-] AWS::Type::Name resourceId
                  const resourceMatch = line.match(/^\s*\[([+~-])\]\s*(AWS::\S+)\s+(.+)/);
                  if (resourceMatch) {
                    const changeType = resourceMatch[1];
                    const icon = changeType === '+' ? 'üü¢' : changeType === '~' ? 'üü°' : 'üî¥';
                    currentResource = {
                      icon,
                      type: resourceMatch[2],
                      name: resourceMatch[3].trim(),
                      properties: []
                    };
                    stackData[stackName].resources.push(currentResource);
                  }
                  
                  // Match property changes (various formats)
                  const propMatch = line.match(/^\s*[‚îî‚îú‚îÄ‚îÇ\s]*([‚Üê‚Üí‚Üî]|Tags:|[\w]+:)\s*(.+)?/);
                  if (propMatch && currentResource && !line.match(/^\s*\[/)) {
                    const propText = line.trim();
                    if (propText && !propText.startsWith('AWS::')) {
                      currentResource.properties.push(propText);
                    }
                  }
                }
              }
            }
            
            const totalChanges = totalAdds + totalUpdates + totalDestroys;
            const totalStacks = Object.keys(stackData).length;
            
            // =================================================================
            // 5.3 Build Slack message with blocks and attachments
            // =================================================================
            
            // Main blocks (header, context, stats, buttons)
            const blocks = [
              {
                type: 'header',
                text: { type: 'plain_text', text: 'üîç CDK Diff Preview', emoji: true }
              },
              {
                type: 'context',
                elements: [
                  { type: 'image', image_url: `https://github.com/${actor}.png`, alt_text: actor },
                  { type: 'mrkdwn', text: `*${actor}* opened <${prUrl}|PR #${prNumber}> in \`${repo}\`` }
                ]
              },
              { type: 'divider' },
              {
                type: 'section',
                fields: [
                  { type: 'mrkdwn', text: `*üü¢ Additions*\n${totalAdds} resources` },
                  { type: 'mrkdwn', text: `*üü° Updates*\n${totalUpdates} resources` },
                  { type: 'mrkdwn', text: `*üî¥ Deletions*\n${totalDestroys} resources` },
                  { type: 'mrkdwn', text: `*üì¶ Stacks*\n${totalStacks} affected` }
                ]
              },
              {
                type: 'actions',
                elements: [
                  {
                    type: 'button',
                    text: { type: 'plain_text', text: 'üìù View PR', emoji: true },
                    url: prUrl,
                    style: 'primary'
                  },
                  {
                    type: 'button',
                    text: { type: 'plain_text', text: '‚öôÔ∏è View Workflow', emoji: true },
                    url: `${context.payload.repository.html_url}/actions/runs/${context.runId}`
                  }
                ]
              }
            ];
            
            // Build attachments for each stack
            const attachments = [];
            
            for (const [stackName, data] of Object.entries(stackData)) {
              // Determine environment from account name or stack name
              const accountId = data.account;
              const envName = accountNames[accountId] || 
                (stackName.toLowerCase().includes('prod') ? 'production' :
                 stackName.toLowerCase().includes('staging') ? 'staging' :
                 stackName.toLowerCase().includes('test') ? 'test' : 'unknown');
              
              // Color based on changes: green if adds only, yellow if updates, red if deletes
              const hasDeletes = data.resources.some(r => r.icon === 'üî¥');
              const hasUpdates = data.resources.some(r => r.icon === 'üü°');
              const color = hasDeletes ? '#dc3545' : hasUpdates ? '#ffc107' : '#2eb886';
              
              const stackBlocks = [
                {
                  type: 'section',
                  text: { type: 'mrkdwn', text: `*üì¶ ${stackName}*` },
                  accessory: {
                    type: 'button',
                    text: { type: 'plain_text', text: envName, emoji: true },
                    style: 'primary'
                  }
                }
              ];
              
              // Add account/region context if available
              if (accountId) {
                stackBlocks.push({
                  type: 'context',
                  elements: [
                    { type: 'mrkdwn', text: `Account: \`${accountId}\` ‚Ä¢ Region: \`${data.region || 'us-east-1'}\`` }
                  ]
                });
              }
              
              stackBlocks.push({ type: 'divider' });
              
              // Add resource changes (limit to 8 per stack to avoid Slack limits)
              const resourcesToShow = data.resources.slice(0, 8);
              for (const resource of resourcesToShow) {
                let resourceText = `${resource.icon} \`${resource.type}\` *${resource.name}*`;
                
                // Add property changes (limit to 2 per resource)
                const propsToShow = resource.properties.slice(0, 2);
                for (const prop of propsToShow) {
                  resourceText += `\n      ‚îî‚îÄ ${prop}`;
                }
                if (resource.properties.length > 2) {
                  resourceText += `\n      ‚îî‚îÄ _...and ${resource.properties.length - 2} more changes_`;
                }
                
                stackBlocks.push({
                  type: 'section',
                  text: { type: 'mrkdwn', text: resourceText }
                });
              }
              
              // Show if there are more resources
              if (data.resources.length > 8) {
                stackBlocks.push({
                  type: 'context',
                  elements: [
                    { type: 'mrkdwn', text: `_...and ${data.resources.length - 8} more resources_` }
                  ]
                });
              }
              
              attachments.push({ color, blocks: stackBlocks });
            }
            
            // If no changes, add a simple message
            if (totalChanges === 0) {
              attachments.push({
                color: '#2eb886',
                blocks: [
                  {
                    type: 'section',
                    text: { type: 'mrkdwn', text: '‚úÖ No infrastructure changes detected' }
                  }
                ]
              });
            }
            
            const payload = { blocks, attachments };
            
            // =================================================================
            // 5.4 Send to Slack
            // =================================================================
            const https = require('https');
            const url = new URL(process.env.SLACK_WEBHOOK_URL);
            
            const options = {
              hostname: url.hostname,
              path: url.pathname,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            };
            
            await new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => data += chunk);
                res.on('end', () => {
                  console.log(`Slack response: ${res.statusCode} - ${data}`);
                  if (res.statusCode === 200) {
                    resolve();
                  } else {
                    reject(new Error(`Slack API returned ${res.statusCode}: ${data}`));
                  }
                });
              });
              req.on('error', reject);
              req.write(JSON.stringify(payload));
              req.end();
            });
            
            console.log('Slack notification sent successfully');
