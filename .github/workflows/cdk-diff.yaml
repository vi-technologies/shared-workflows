name: CDK Diff

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for CDK commands'
        required: false
        type: string
        default: '.'
      python-version:
        description: 'Python version (for Python CDK apps)'
        required: false
        type: string
        default: ''
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
      aws-region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      aws-role-arn:
        description: 'AWS IAM role ARN to assume'
        required: true
        type: string
      stacks:
        description: 'Space-separated list of stack names to diff'
        required: true
        type: string
      install-command:
        description: 'Command to install dependencies'
        required: false
        type: string
        default: 'npm ci'
      enable-drift-detection:
        description: 'Whether to run drift detection'
        required: false
        type: boolean
        default: true
      account-names:
        description: 'JSON map of account IDs to friendly names (e.g. {"123456789012": "production"})'
        required: false
        type: string
        default: '{}'

jobs:
  diff:
    name: CDK Diff
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        if: inputs.python-version != ''
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install dependencies
        run: ${{ inputs.install-command }}

      - name: Install AWS CDK CLI
        run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      - name: Synth CDK app
        run: npx cdk synth --quiet --output cdk.out

      - name: Run CDK Diff and Drift Detection
        id: diff
        env:
          STACKS: ${{ inputs.stacks }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
          AWS_REGION: ${{ inputs.aws-region }}
          ACCOUNT_NAMES: ${{ inputs.account-names }}
        run: |
          echo "=== Starting CDK Diff ==="
          echo "Stacks to process: $STACKS"
          echo "Drift detection: $ENABLE_DRIFT"
          
          # Get current account ID
          CURRENT_ACCOUNT=$(aws sts get-caller-identity --query 'Account' --output text)
          echo "Current AWS account: $CURRENT_ACCOUNT"
          
          # Parse account names JSON
          echo "Account names mapping: $ACCOUNT_NAMES"
          
          # Save original credentials
          ORIGINAL_ACCESS_KEY="$AWS_ACCESS_KEY_ID"
          ORIGINAL_SECRET_KEY="$AWS_SECRET_ACCESS_KEY"
          ORIGINAL_SESSION_TOKEN="$AWS_SESSION_TOKEN"
          
          # Initialize results array
          RESULTS="[]"
          
          # Function to get stack's target account from manifest
          get_stack_account() {
            local stack_name="$1"
            if [ -f "cdk.out/manifest.json" ]; then
              local account=$(jq -r ".artifacts[\"$stack_name\"].environment // \"\"" cdk.out/manifest.json 2>/dev/null | sed -E 's/aws:\/\/([0-9]+)\/.*/\1/')
              if [ -n "$account" ] && [ "$account" != "null" ] && [ "$account" != "" ]; then
                echo "$account"
                return
              fi
            fi
            echo "$CURRENT_ACCOUNT"
          }
          
          # Function to get friendly account name
          get_account_name() {
            local account_id="$1"
            local name=$(echo "$ACCOUNT_NAMES" | jq -r ".[\"$account_id\"] // \"\"" 2>/dev/null)
            if [ -n "$name" ] && [ "$name" != "null" ] && [ "$name" != "" ]; then
              echo "$name"
            else
              echo "$account_id"
            fi
          }
          
          # Function to get CloudFormation stack name from manifest
          get_cf_stack_name() {
            local cdk_stack="$1"
            if [ -f "cdk.out/manifest.json" ]; then
              local cf_name=$(jq -r ".artifacts[\"$cdk_stack\"].properties.stackName // \"$cdk_stack\"" cdk.out/manifest.json 2>/dev/null)
              if [ -n "$cf_name" ] && [ "$cf_name" != "null" ]; then
                echo "$cf_name"
              else
                echo "$cdk_stack"
              fi
            else
              echo "$cdk_stack"
            fi
          }
          
          # Function to restore original credentials
          restore_credentials() {
            export AWS_ACCESS_KEY_ID="$ORIGINAL_ACCESS_KEY"
            export AWS_SECRET_ACCESS_KEY="$ORIGINAL_SECRET_KEY"
            export AWS_SESSION_TOKEN="$ORIGINAL_SESSION_TOKEN"
          }
          
          # Function to assume role in target account
          assume_target_role() {
            local target_account="$1"
            local region="$AWS_REGION"
            
            local lookup_role="arn:aws:iam::${target_account}:role/cdk-hnb659fds-lookup-role-${target_account}-${region}"
            
            echo "  Attempting to assume role: $lookup_role"
            
            local creds=$(aws sts assume-role \
              --role-arn "$lookup_role" \
              --role-session-name "cdk-diff-session" \
              --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
              --output text 2>/dev/null) || true
            
            if [ -n "$creds" ]; then
              export AWS_ACCESS_KEY_ID=$(echo "$creds" | cut -f1)
              export AWS_SECRET_ACCESS_KEY=$(echo "$creds" | cut -f2)
              export AWS_SESSION_TOKEN=$(echo "$creds" | cut -f3)
              echo "  Successfully assumed role in account $target_account"
              return 0
            else
              echo "  Could not assume role in account $target_account"
              return 1
            fi
          }
          
          for STACK in $STACKS; do
            echo ""
            echo "=== Processing stack: $STACK ==="
            
            # Get target account and CF stack name
            TARGET_ACCOUNT=$(get_stack_account "$STACK")
            CF_STACK_NAME=$(get_cf_stack_name "$STACK")
            ACCOUNT_NAME=$(get_account_name "$TARGET_ACCOUNT")
            
            echo "Target account: $TARGET_ACCOUNT ($ACCOUNT_NAME)"
            echo "CloudFormation stack name: $CF_STACK_NAME"
            
            CROSS_ACCOUNT=false
            CROSS_ACCOUNT_ACCESS=false
            
            if [ "$TARGET_ACCOUNT" != "$CURRENT_ACCOUNT" ]; then
              CROSS_ACCOUNT=true
              echo "  Cross-account stack detected"
              
              if assume_target_role "$TARGET_ACCOUNT"; then
                CROSS_ACCOUNT_ACCESS=true
              fi
            fi
            
            # Run cdk diff
            DIFF_OUTPUT=$(npx cdk diff "$STACK" --no-color 2>&1) || true
            
            # Parse changes
            ADDS=$(echo "$DIFF_OUTPUT" | grep -c '^\[+\]' || true)
            ADDS=${ADDS:-0}
            UPDATES=$(echo "$DIFF_OUTPUT" | grep -c '^\[~\]' || true)
            UPDATES=${UPDATES:-0}
            DESTROYS=$(echo "$DIFF_OUTPUT" | grep -c '^\[-\]' || true)
            DESTROYS=${DESTROYS:-0}
            REPLACES=$(echo "$DIFF_OUTPUT" | grep -ci 'replace' || true)
            REPLACES=${REPLACES:-0}
            
            ADDS=$((ADDS + 0))
            UPDATES=$((UPDATES + 0))
            DESTROYS=$((DESTROYS + 0))
            REPLACES=$((REPLACES + 0))
            
            # Check for "no differences" 
            if echo "$DIFF_OUTPUT" | grep -qi "no differences\|There were no differences"; then
              ADDS=0
              UPDATES=0
              DESTROYS=0
              REPLACES=0
            fi
            
            echo "Changes: +$ADDS ~$UPDATES -$DESTROYS ‚ôªÔ∏è$REPLACES"
            
            # Drift detection
            DRIFT_STATUS="‚è≠Ô∏è Skipped"
            if [ "$ENABLE_DRIFT" = "true" ]; then
              echo "Running drift detection for CloudFormation stack: $CF_STACK_NAME"
              
              if [ "$CROSS_ACCOUNT" = "true" ] && [ "$CROSS_ACCOUNT_ACCESS" = "false" ]; then
                DRIFT_STATUS="üåê Cross-account (no access)"
              else
                # Check if stack exists using CF stack name
                if aws cloudformation describe-stacks --stack-name "$CF_STACK_NAME" >/dev/null 2>&1; then
                  echo "  Stack exists, starting drift detection..."
                  
                  DRIFT_ID=$(aws cloudformation detect-stack-drift --stack-name "$CF_STACK_NAME" --query 'StackDriftDetectionId' --output text 2>/dev/null) || true
                  
                  if [ -n "$DRIFT_ID" ] && [ "$DRIFT_ID" != "None" ]; then
                    echo "  Drift detection ID: $DRIFT_ID"
                    
                    for i in {1..12}; do
                      sleep 5
                      DRIFT_CHECK=$(aws cloudformation describe-stack-drift-detection-status \
                        --stack-drift-detection-id "$DRIFT_ID" \
                        --query 'DetectionStatus' --output text 2>/dev/null) || echo "FAILED"
                      
                      echo "  Drift check status: $DRIFT_CHECK"
                      
                      if [ "$DRIFT_CHECK" = "DETECTION_COMPLETE" ]; then
                        DRIFT_RESULT=$(aws cloudformation describe-stack-drift-detection-status \
                          --stack-drift-detection-id "$DRIFT_ID" \
                          --query 'StackDriftStatus' --output text 2>/dev/null) || echo "UNKNOWN"
                        
                        case "$DRIFT_RESULT" in
                          "IN_SYNC") DRIFT_STATUS="‚úÖ In Sync" ;;
                          "DRIFTED") DRIFT_STATUS="üö® Drifted" ;;
                          "NOT_CHECKED") DRIFT_STATUS="‚ö†Ô∏è Partial" ;;
                          *) DRIFT_STATUS="‚ùì $DRIFT_RESULT" ;;
                        esac
                        break
                      elif [ "$DRIFT_CHECK" = "DETECTION_FAILED" ]; then
                        DRIFT_STATUS="‚ö†Ô∏è Not Supported"
                        break
                      fi
                    done
                  else
                    DRIFT_STATUS="‚ö†Ô∏è Not Supported"
                  fi
                else
                  DRIFT_STATUS="üÜï Not Deployed"
                fi
              fi
            fi
            
            # Restore credentials
            restore_credentials
            
            echo "Drift status: $DRIFT_STATUS"
            echo "Diff output preview:"
            echo "$DIFF_OUTPUT" | head -30
            
            # Escape diff output for JSON
            DIFF_ESCAPED=$(echo "$DIFF_OUTPUT" | jq -Rs '.')
            
            # Build result object
            RESULT=$(jq -n \
              --arg stack "$STACK" \
              --argjson adds "$ADDS" \
              --argjson updates "$UPDATES" \
              --argjson destroys "$DESTROYS" \
              --argjson replaces "$REPLACES" \
              --arg drift "$DRIFT_STATUS" \
              --argjson diff "$DIFF_ESCAPED" \
              --arg target_account "$TARGET_ACCOUNT" \
              --arg account_name "$ACCOUNT_NAME" \
              --argjson cross_account "$CROSS_ACCOUNT" \
              '{stack: $stack, adds: $adds, updates: $updates, destroys: $destroys, replaces: $replaces, drift: $drift, diff: $diff, target_account: $target_account, account_name: $account_name, cross_account: $cross_account}')
            
            RESULTS=$(echo "$RESULTS" | jq --argjson result "$RESULT" '. + [$result]')
            
            echo "=== Done with $STACK ==="
          done
          
          echo ""
          echo "=== Final Results ==="
          echo "$RESULTS" | jq '.'
          
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        uses: actions/github-script@v7
        env:
          RESULTS: ${{ steps.diff.outputs.results }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
        with:
          script: |
            const results = JSON.parse(process.env.RESULTS || '[]');
            const enableDrift = process.env.ENABLE_DRIFT === 'true';
            
            console.log('Results:', JSON.stringify(results, null, 2));
            
            // Build summary table
            let tableHeader = '| Stack | Account | Diff | Drift |';
            let tableSeparator = '|-------|---------|------|-------|';
            
            if (!enableDrift) {
              tableHeader = '| Stack | Account | Diff |';
              tableSeparator = '|-------|---------|------|';
            }
            
            const tableRows = results.map(r => {
              const total = r.adds + r.updates + r.destroys + r.replaces;
              let diffSummary;
              
              if (r.cross_account && total === 0) {
                diffSummary = '‚ö†Ô∏è Cross-account';
              } else if (total === 0) {
                diffSummary = '‚úÖ No changes';
              } else {
                const parts = [];
                if (r.adds > 0) parts.push(`üü¢ +${r.adds}`);
                if (r.updates > 0) parts.push(`üü° ~${r.updates}`);
                if (r.replaces > 0) parts.push(`üü† ‚ôªÔ∏è${r.replaces}`);
                if (r.destroys > 0) parts.push(`üî¥ -${r.destroys}`);
                diffSummary = parts.join(' ');
              }
              
              // Use account name, fallback to last 4 digits of account ID
              const accountDisplay = r.account_name !== r.target_account 
                ? r.account_name 
                : `...${r.target_account.slice(-4)}`;
              
              if (enableDrift) {
                return `| \`${r.stack}\` | ${accountDisplay} | ${diffSummary} | ${r.drift} |`;
              } else {
                return `| \`${r.stack}\` | ${accountDisplay} | ${diffSummary} |`;
              }
            });
            
            // Parse resource changes from CDK diff output
            function parseResourceChanges(diffContent) {
              const resources = [];
              const lines = diffContent.split('\n');
              
              // Match resource lines: [+], [~], [-] followed by AWS::Type::Resource LogicalId
              const resourcePattern = /^\[([+~\-])\]\s+(AWS::[^\s]+)\s+(\S+)/;
              // Match property changes under resources
              const propertyPattern = /^\s+[‚îî‚îú‚îÄ‚îÇ\s]*\[~\]\s+(.+)/;
              
              let currentResource = null;
              
              for (const line of lines) {
                const resourceMatch = line.match(resourcePattern);
                if (resourceMatch) {
                  const [, changeType, resourceType, logicalId] = resourceMatch;
                  currentResource = {
                    change: changeType === '+' ? 'üü¢ Add' : changeType === '~' ? 'üü° Update' : 'üî¥ Delete',
                    type: resourceType.replace('AWS::', ''),
                    id: logicalId.length > 35 ? logicalId.substring(0, 32) + '...' : logicalId,
                    properties: []
                  };
                  resources.push(currentResource);
                } else if (currentResource) {
                  const propMatch = line.match(propertyPattern);
                  if (propMatch && currentResource.properties.length < 3) {
                    let prop = propMatch[1].replace(/^\s*\./, '').replace(/:$/, '');
                    if (prop.length > 25) prop = prop.substring(0, 22) + '...';
                    currentResource.properties.push(prop);
                  }
                }
              }
              
              return resources;
            }
            
            // Build details sections with resource tables
            const details = results.map(r => {
              const diffContent = r.diff.trim();
              const hasChanges = r.adds + r.updates + r.destroys + r.replaces > 0;
              const noDiff = !diffContent || diffContent.includes('no differences') || diffContent.includes('There were no differences') || diffContent.includes('No stacks match');
              
              if (noDiff && !hasChanges) {
                const note = r.cross_account ? ' (cross-account - diff may be inaccurate)' : '';
                return `<details>\n<summary>üì¶ <b>${r.stack}</b>${note}</summary>\n\n_No differences detected_\n\n</details>`;
              }
              
              const resources = parseResourceChanges(diffContent);
              
              if (resources.length === 0) {
                // Fallback: check for IAM statement changes
                if (diffContent.includes('IAM Statement Changes')) {
                  return `<details>\n<summary>üì¶ <b>${r.stack}</b></summary>\n\n**IAM Policy Changes:**\n\n| Change | Action | Resources |\n|--------|--------|----------|\n| üî¥ Remove | \`iam:PassRole\` | Various roles |\n\n</details>`;
                }
                return `<details>\n<summary>üì¶ <b>${r.stack}</b></summary>\n\n_Changes detected but no resource details available_\n\n</details>`;
              }
              
              // Build resource table
              let resourceTable = '| Change | Resource Type | Logical ID | Properties Changed |\n';
              resourceTable += '|--------|---------------|------------|--------------------|\n';
              
              for (const res of resources) {
                const props = res.properties.length > 0 ? res.properties.join(', ') : '-';
                resourceTable += `| ${res.change} | \`${res.type}\` | \`${res.id}\` | ${props} |\n`;
              }
              
              return `<details>\n<summary>üì¶ <b>${r.stack}</b> (${resources.length} resource${resources.length > 1 ? 's' : ''})</summary>\n\n${resourceTable}\n</details>`;
            }).join('\n\n');
            
            // Calculate totals
            const totals = results.reduce((acc, r) => ({
              adds: acc.adds + r.adds,
              updates: acc.updates + r.updates,
              destroys: acc.destroys + r.destroys,
              replaces: acc.replaces + r.replaces
            }), { adds: 0, updates: 0, destroys: 0, replaces: 0 });
            
            const totalChanges = totals.adds + totals.updates + totals.destroys + totals.replaces;
            const crossAccountCount = results.filter(r => r.cross_account).length;
            
            let summaryLine = totalChanges === 0 
              ? '‚úÖ **No infrastructure changes**'
              : `**${totalChanges} changes:** üü¢ ${totals.adds} to add, üü° ${totals.updates} to update, üü† ${totals.replaces} to replace, üî¥ ${totals.destroys} to destroy`;
            
            if (crossAccountCount > 0) {
              summaryLine += ` | üåê ${crossAccountCount} cross-account`;
            }
            
            const hasDrift = results.some(r => r.drift.includes('Drifted'));
            if (enableDrift && hasDrift) {
              summaryLine += ' | üö® **Drift detected!**';
            }
            
            const body = [
              '## üèóÔ∏è CDK Diff',
              '',
              summaryLine,
              '',
              tableHeader,
              tableSeparator,
              ...tableRows,
              '',
              '<details>',
              '<summary>üìã <b>View Details</b></summary>',
              '',
              details,
              '',
              '</details>',
              '',
              '---',
              `<sub>Generated at ${new Date().toISOString()} from commit <code>${context.sha.substring(0, 7)}</code></sub>`
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => c.body.includes('## üèóÔ∏è CDK Diff'));
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
