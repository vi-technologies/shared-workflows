# =============================================================================
# CDK DIFF WORKFLOW (using @aws-cdk/toolkit-lib)
# =============================================================================
# Runs CDK diff in parallel for each account using matrix strategy.
# Each account gets its own OIDC authentication - no cross-account trust needed.
# =============================================================================

name: CDK Diff

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for CDK commands'
        required: false
        type: string
        default: '.'
      python-version:
        description: 'Python version (for Python CDK apps)'
        required: false
        type: string
        default: ''
      node-version:
        description: 'Node.js version (18+ required)'
        required: false
        type: string
        default: '20'
      install-command:
        description: 'Command to install dependencies'
        required: false
        type: string
        default: 'npm ci'
      aws-region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      aws-role-arn:
        description: 'AWS IAM role ARN (single account mode)'
        required: false
        type: string
        default: ''
      aws-role-arns:
        description: 'JSON map of account IDs to role ARNs (multi-account)'
        required: false
        type: string
        default: ''
      stacks:
        description: 'Space-separated stack names (single account)'
        required: false
        type: string
        default: ''
      stacks-per-account:
        description: 'JSON map of account IDs to stack lists (multi-account)'
        required: false
        type: string
        default: ''
      enable-drift-detection:
        description: 'Run drift detection'
        required: false
        type: boolean
        default: true
      account-names:
        description: 'JSON map of account IDs to friendly names'
        required: false
        type: string
        default: '{}'
      pr-number:
        description: 'Pull request number'
        required: false
        type: number
        default: 0
      enable-cost-estimate:
        description: 'Estimate monthly cost impact using AWS Pricing API'
        required: false
        type: boolean
        default: false
      slack-notify-label:
        description: 'PR label that triggers Slack notification'
        required: false
        type: string
        default: 'slack-notify'
    secrets:
      slack-webhook-url:
        description: 'Slack webhook URL'
        required: false

jobs:
  # ===========================================================================
  # PREPARE: Build matrix of accounts to diff
  # ===========================================================================
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      is-multi-account: ${{ steps.matrix.outputs.is_multi }}
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: .github/scripts
          path: _shared

      - name: Build matrix
        id: matrix
        env:
          ROLE_ARNS: ${{ inputs.aws-role-arns }}
          STACKS_PER_ACCOUNT: ${{ inputs.stacks-per-account }}
        run: bash _shared/.github/scripts/build-diff-matrix.sh

  # ===========================================================================
  # SINGLE ACCOUNT MODE
  # ===========================================================================
  diff-single:
    name: Diff (iac-aws-org)
    if: needs.prepare.outputs.is-multi-account == 'false' && inputs.aws-role-arn != ''
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    outputs:
      result: ${{ steps.diff.outputs.result }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        if: inputs.python-version != ''
        with:
          python-version: ${{ inputs.python-version }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      - run: ${{ inputs.install-command }}
      - run: npm install -g aws-cdk
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: .github/scripts
          path: _shared

      - name: Run diff
        id: diff
        env:
          STACKS: ${{ inputs.stacks }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
          WORK_DIR: ${{ github.workspace }}/${{ inputs.working-directory }}
          SCRIPT_PATH: ${{ github.workspace }}/_shared/.github/scripts/run-cdk-diff.mjs
        run: bash ${{ github.workspace }}/_shared/.github/scripts/run-cdk-diff-wrapper.sh

  # ===========================================================================
  # MULTI-ACCOUNT: Parallel matrix jobs
  # ===========================================================================
  diff-multi:
    name: Diff (${{ matrix.account }})
    if: needs.prepare.outputs.is-multi-account == 'true'
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    outputs:
      # Matrix outputs - collected by aggregate job
      result: ${{ steps.diff.outputs.result }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        if: inputs.python-version != ''
        with:
          python-version: ${{ inputs.python-version }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      - run: ${{ inputs.install-command }}
      - run: npm install -g aws-cdk

      - name: Configure AWS (${{ matrix.account }})
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: .github/scripts
          path: _shared

      - name: Run diff
        id: diff
        env:
          STACKS: ${{ matrix.stacks }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
          CDK_DEFAULT_ACCOUNT: ${{ matrix.account }}
          CDK_DEFAULT_REGION: ${{ inputs.aws-region }}
          WORK_DIR: ${{ github.workspace }}/${{ inputs.working-directory }}
          SCRIPT_PATH: ${{ github.workspace }}/_shared/.github/scripts/run-cdk-diff.mjs
        run: |
          [ -z "$STACKS" ] && echo 'result={"success":true,"stacks":[]}' >> $GITHUB_OUTPUT && exit 0
          bash ${{ github.workspace }}/_shared/.github/scripts/run-cdk-diff-wrapper.sh

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: diff-${{ matrix.account }}
          path: /tmp/result.json
          retention-days: 1

  # ===========================================================================
  # AGGREGATE: Combine multi-account results
  # ===========================================================================
  aggregate:
    name: Aggregate Results
    if: needs.prepare.outputs.is-multi-account == 'true'
    needs: [prepare, diff-multi]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    outputs:
      combined: ${{ steps.combine.outputs.result }}
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: .github/scripts
          path: _shared

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/diffs
          pattern: diff-*

      - name: Combine results
        id: combine
        env:
          DIFFS_DIR: /tmp/diffs
        run: bash _shared/.github/scripts/combine-diff-results.sh

  # ===========================================================================
  # COMMENT: Post PR comment, cost estimate, and Slack
  # ===========================================================================
  comment:
    name: Post Comment
    needs: [prepare, diff-single, aggregate]
    if: always() && (needs.diff-single.result == 'success' || needs.aggregate.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout (for scripts and resource-map)
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: |
            .github/scripts
            .github/pricing
          path: _shared

      - name: Resolve pricing role ARN
        if: inputs.enable-cost-estimate
        id: pricing-role
        env:
          SINGLE_ROLE_ARN: ${{ inputs.aws-role-arn }}
          MULTI_ROLE_ARNS: ${{ inputs.aws-role-arns }}
        run: bash _shared/.github/scripts/resolve-pricing-role.sh

      - name: Configure AWS credentials (for Pricing API)
        if: inputs.enable-cost-estimate && steps.pricing-role.outputs.arn != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.pricing-role.outputs.arn }}
          role-duration-seconds: 3600
          aws-region: us-east-1

      - name: Install AWS SDK Pricing client
        if: inputs.enable-cost-estimate
        run: npm install @aws-sdk/client-pricing

      - name: Generate comment and Slack blocks
        id: format
        env:
          DIFF_SINGLE: ${{ needs.diff-single.outputs.result }}
          DIFF_MULTI: ${{ needs.aggregate.outputs.combined }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUM: ${{ inputs.pr-number || github.event.pull_request.number }}
          SCRIPT_PATH: _shared/.github/scripts/format-cdk-diff.js
        run: bash _shared/.github/scripts/generate-diff-comment.sh

      - name: Estimate cost impact
        if: inputs.enable-cost-estimate
        id: cost
        env:
          DIFF_JSON: ${{ needs.diff-single.outputs.result || needs.aggregate.outputs.combined }}
          PRICING_REGION: ${{ inputs.aws-region }}
          SCRIPT_PATH: _shared/.github/scripts/estimate-cost.js
          RESOURCE_MAP_PATH: _shared/.github/pricing/resource-map.json
        run: bash _shared/.github/scripts/estimate-cost-wrapper.sh

      - name: Post PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: cdk-diff
          number: ${{ inputs.pr-number || github.event.pull_request.number }}
          message: |
            ${{ steps.format.outputs.comment }}
            ${{ steps.cost.outputs.cost_comment || '' }}

      - name: Check Slack label
        id: check-label
        env:
          SLACK_WEBHOOK: ${{ secrets.slack-webhook-url }}
          PR_NUM: ${{ inputs.pr-number || github.event.pull_request.number || 0 }}
          SLACK_NOTIFY_LABEL: ${{ inputs.slack-notify-label }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const scriptContent = fs.readFileSync('_shared/.github/scripts/check-slack-label.js', 'utf8');
            const fn = new Function('github', 'context', 'core', `return (async () => { ${scriptContent} })();`);
            await fn(github, context, core);

      - name: Send Slack
        if: steps.check-label.outputs.notify == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack-webhook-url }}
          SLACK_BLOCKS: ${{ steps.format.outputs.slack_blocks }}
        run: bash _shared/.github/scripts/send-slack.sh
