# =============================================================================
# CDK DIFF WORKFLOW (using @aws-cdk/toolkit-lib)
# =============================================================================
# Runs CDK diff in parallel for each account using matrix strategy.
# Each account gets its own OIDC authentication - no cross-account trust needed.
# =============================================================================

name: CDK Diff

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for CDK commands'
        required: false
        type: string
        default: '.'
      python-version:
        description: 'Python version (for Python CDK apps)'
        required: false
        type: string
        default: ''
      node-version:
        description: 'Node.js version (18+ required)'
        required: false
        type: string
        default: '20'
      install-command:
        description: 'Command to install dependencies'
        required: false
        type: string
        default: 'npm ci'
      aws-region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      aws-role-arn:
        description: 'AWS IAM role ARN (single account mode)'
        required: false
        type: string
        default: ''
      aws-role-arns:
        description: 'JSON map of account IDs to role ARNs (multi-account)'
        required: false
        type: string
        default: ''
      stacks:
        description: 'Space-separated stack names (single account)'
        required: false
        type: string
        default: ''
      stacks-per-account:
        description: 'JSON map of account IDs to stack lists (multi-account)'
        required: false
        type: string
        default: ''
      enable-drift-detection:
        description: 'Run drift detection'
        required: false
        type: boolean
        default: true
      account-names:
        description: 'JSON map of account IDs to friendly names'
        required: false
        type: string
        default: '{}'
      pr-number:
        description: 'Pull request number'
        required: false
        type: number
        default: 0
      enable-cost-estimate:
        description: 'Estimate monthly cost impact using AWS Pricing API'
        required: false
        type: boolean
        default: false
      slack-notify-label:
        description: 'PR label that triggers Slack notification'
        required: false
        type: string
        default: 'slack-notify'
    secrets:
      slack-webhook-url:
        description: 'Slack webhook URL'
        required: false

jobs:
  # ===========================================================================
  # PREPARE: Build matrix of accounts to diff
  # ===========================================================================
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      is-multi-account: ${{ steps.matrix.outputs.is_multi }}
    steps:
      - name: Build matrix
        id: matrix
        run: |
          if [ -n '${{ inputs.aws-role-arns }}' ] && [ -n '${{ inputs.stacks-per-account }}' ]; then
            echo "is_multi=true" >> $GITHUB_OUTPUT
            # Build matrix from role ARNs and stacks
            MATRIX=$(echo '${{ inputs.aws-role-arns }}' | jq -c --argjson stacks '${{ inputs.stacks-per-account }}' '
              to_entries | map({
                account: .key,
                role: .value,
                stacks: ($stacks[.key] // "")
              }) | {include: .}
            ')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          else
            echo "is_multi=false" >> $GITHUB_OUTPUT
            echo 'matrix={"include":[]}' >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # SINGLE ACCOUNT MODE
  # ===========================================================================
  diff-single:
    name: Diff (iac-aws-org)
    if: needs.prepare.outputs.is-multi-account == 'false' && inputs.aws-role-arn != ''
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    outputs:
      result: ${{ steps.diff.outputs.result }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        if: inputs.python-version != ''
        with:
          python-version: ${{ inputs.python-version }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      - run: ${{ inputs.install-command }}
      - run: npm install -g aws-cdk
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}
      - name: Run diff
        id: diff
        env:
          STACKS: ${{ inputs.stacks }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
        run: |
          npx cdk synth --quiet --output cdk.out
          
          mkdir -p /tmp/cdk-runner && cd /tmp/cdk-runner
          echo '{"type":"module","dependencies":{"@aws-cdk/toolkit-lib":"*"}}' > package.json
          npm install --silent
          
          cat > run.js << 'SCRIPT'
          import { Toolkit, StackSelectionStrategy } from '@aws-cdk/toolkit-lib';
          const stacks = (process.env.STACKS || '').split(' ').filter(Boolean);
          const enableDrift = process.env.ENABLE_DRIFT === 'true';
          async function main() {
            const output = { success: false, stacks: [], error: '' };
            try {
              const toolkit = new Toolkit({ ioHost: { notify: async () => {}, requestResponse: async (msg) => msg.defaultResponse } });
              const cx = await toolkit.fromAssemblyDirectory(process.env.CDK_OUT);
              const selector = stacks.length ? { strategy: StackSelectionStrategy.PATTERN_MUST_MATCH, patterns: stacks } : { strategy: StackSelectionStrategy.ALL_STACKS };
              const diffResults = await toolkit.diff(cx, { stacks: selector });
              const fmtVal = (v) => v === undefined || v === null ? null : typeof v === 'object' ? JSON.stringify(v) : String(v);
              for (const [name, diff] of Object.entries(diffResults)) {
                const result = { stackName: name, hasDiff: false, resources: [] };
                for (const [logicalId, resDiff] of Object.entries(diff.resources?.diffs || {})) {
                  const type = resDiff.resourceTypes?.newType || resDiff.resourceTypes?.oldType || 'Unknown';
                  const action = resDiff.isAddition ? 'ADD' : resDiff.isRemoval ? 'REMOVE' : 'UPDATE';
                  const properties = Object.entries(resDiff.propertyDiffs || {}).filter(([_, p]) => p.isDifferent).map(([n, p]) => ({ name: n, impact: p.changeImpact || 'UNKNOWN', oldValue: fmtVal(p.oldValue), newValue: fmtVal(p.newValue) }));
                  result.resources.push({ logicalId, type, action, properties });
                  result.hasDiff = true;
                }
                if (enableDrift) { try { const dr = await toolkit.drift(cx, { stacks: { strategy: StackSelectionStrategy.PATTERN_MUST_MATCH, patterns: [name] } }); result.drift = { status: (dr[name]?.numResourcesWithDrift || 0) > 0 ? 'DRIFTED' : 'IN_SYNC', count: dr[name]?.numResourcesWithDrift || 0 }; } catch {} }
                output.stacks.push(result);
              }
              output.success = true;
            } catch (e) { output.error = e.message || String(e); }
            console.log(JSON.stringify(output));
          }
          main();
          SCRIPT
          
          cd ${{ github.workspace }}/${{ inputs.working-directory }}
          CDK_OUT="$(pwd)/cdk.out" node /tmp/cdk-runner/run.js > /tmp/result.json 2>&1 || true
          RESULT=$(cat /tmp/result.json | tail -1 || echo '{"success":false,"error":"no output","stacks":[]}')
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ===========================================================================
  # MULTI-ACCOUNT: Parallel matrix jobs
  # ===========================================================================
  diff-multi:
    name: Diff (${{ matrix.account }})
    if: needs.prepare.outputs.is-multi-account == 'true'
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    outputs:
      # Matrix outputs - collected by aggregate job
      result: ${{ steps.diff.outputs.result }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        if: inputs.python-version != ''
        with:
          python-version: ${{ inputs.python-version }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
      - run: ${{ inputs.install-command }}
      - run: npm install -g aws-cdk

      - name: Configure AWS (${{ matrix.account }})
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      - name: Run diff
        id: diff
        env:
          STACKS: ${{ matrix.stacks }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
          CDK_DEFAULT_ACCOUNT: ${{ matrix.account }}
          CDK_DEFAULT_REGION: ${{ inputs.aws-region }}
        run: |
          [ -z "$STACKS" ] && echo 'result={"success":true,"stacks":[]}' >> $GITHUB_OUTPUT && exit 0
          
          npx cdk synth --quiet --output cdk.out
          
          mkdir -p /tmp/cdk-runner && cd /tmp/cdk-runner
          echo '{"type":"module","dependencies":{"@aws-cdk/toolkit-lib":"*"}}' > package.json
          npm install --silent
          
          cat > run.js << 'SCRIPT'
          import { Toolkit, StackSelectionStrategy } from '@aws-cdk/toolkit-lib';
          const stacks = (process.env.STACKS || '').split(' ').filter(Boolean);
          const enableDrift = process.env.ENABLE_DRIFT === 'true';
          async function main() {
            const output = { success: false, stacks: [], error: '' };
            try {
              const toolkit = new Toolkit({ ioHost: { notify: async () => {}, requestResponse: async (msg) => msg.defaultResponse } });
              const cx = await toolkit.fromAssemblyDirectory(process.env.CDK_OUT);
              const selector = stacks.length ? { strategy: StackSelectionStrategy.PATTERN_MUST_MATCH, patterns: stacks } : { strategy: StackSelectionStrategy.ALL_STACKS };
              const diffResults = await toolkit.diff(cx, { stacks: selector });
              const fmtVal = (v) => v === undefined || v === null ? null : typeof v === 'object' ? JSON.stringify(v) : String(v);
              for (const [name, diff] of Object.entries(diffResults)) {
                const result = { stackName: name, hasDiff: false, resources: [] };
                for (const [logicalId, resDiff] of Object.entries(diff.resources?.diffs || {})) {
                  const type = resDiff.resourceTypes?.newType || resDiff.resourceTypes?.oldType || 'Unknown';
                  const action = resDiff.isAddition ? 'ADD' : resDiff.isRemoval ? 'REMOVE' : 'UPDATE';
                  const properties = Object.entries(resDiff.propertyDiffs || {}).filter(([_, p]) => p.isDifferent).map(([n, p]) => ({ name: n, impact: p.changeImpact || 'UNKNOWN', oldValue: fmtVal(p.oldValue), newValue: fmtVal(p.newValue) }));
                  result.resources.push({ logicalId, type, action, properties });
                  result.hasDiff = true;
                }
                if (enableDrift) { try { const dr = await toolkit.drift(cx, { stacks: { strategy: StackSelectionStrategy.PATTERN_MUST_MATCH, patterns: [name] } }); result.drift = { status: (dr[name]?.numResourcesWithDrift || 0) > 0 ? 'DRIFTED' : 'IN_SYNC', count: dr[name]?.numResourcesWithDrift || 0 }; } catch {} }
                output.stacks.push(result);
              }
              output.success = true;
            } catch (e) { output.error = e.message || String(e); }
            console.log(JSON.stringify(output));
          }
          main();
          SCRIPT
          
          cd ${{ github.workspace }}/${{ inputs.working-directory }}
          CDK_OUT="$(pwd)/cdk.out" node /tmp/cdk-runner/run.js > /tmp/result.json 2>&1 || true
          RESULT=$(cat /tmp/result.json | tail -1 || echo '{"success":false,"error":"no output","stacks":[]}')
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: diff-${{ matrix.account }}
          path: /tmp/result.json
          retention-days: 1

  # ===========================================================================
  # AGGREGATE: Combine multi-account results
  # ===========================================================================
  aggregate:
    name: Aggregate Results
    if: needs.prepare.outputs.is-multi-account == 'true'
    needs: [prepare, diff-multi]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    outputs:
      combined: ${{ steps.combine.outputs.result }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/diffs
          pattern: diff-*

      - name: Combine results
        id: combine
        run: |
          ALL_STACKS='[]'
          for f in /tmp/diffs/*/result.json; do
            if [ -f "$f" ]; then
              STACKS=$(cat "$f" | tail -1 | jq -c '.stacks // []')
              ALL_STACKS=$(echo "$ALL_STACKS" | jq --argjson new "$STACKS" '. + $new')
            fi
          done
          RESULT='{"success":true,"stacks":'$ALL_STACKS'}'
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ===========================================================================
  # COMMENT: Post PR comment, cost estimate, and Slack (inline formatter)
  # ===========================================================================
  comment:
    name: Post Comment
    needs: [prepare, diff-single, aggregate]
    if: always() && (needs.diff-single.result == 'success' || needs.aggregate.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: Checkout (for scripts and resource-map)
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: ${{ github.job_workflow_sha }}
          sparse-checkout: |
            .github/scripts
            .github/pricing
          path: _shared

      - name: Resolve pricing role ARN
        if: inputs.enable-cost-estimate
        id: pricing-role
        run: |
          if [ -n '${{ inputs.aws-role-arn }}' ]; then
            echo "arn=${{ inputs.aws-role-arn }}" >> $GITHUB_OUTPUT
          else
            # Multi-account: use the first role ARN for Pricing API (it's global)
            ARN=$(echo '${{ inputs.aws-role-arns }}' | jq -r 'to_entries[0].value // empty')
            echo "arn=$ARN" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS credentials (for Pricing API)
        if: inputs.enable-cost-estimate && steps.pricing-role.outputs.arn != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.pricing-role.outputs.arn }}
          role-duration-seconds: 3600
          aws-region: us-east-1

      - name: Install AWS SDK Pricing client
        if: inputs.enable-cost-estimate
        run: npm install @aws-sdk/client-pricing

      - name: Generate comment and Slack blocks
        id: format
        env:
          DIFF_SINGLE: ${{ needs.diff-single.outputs.result }}
          DIFF_MULTI: ${{ needs.aggregate.outputs.combined }}
          REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUM: ${{ inputs.pr-number || github.event.pull_request.number }}
        run: |
          DIFF_JSON="${DIFF_SINGLE:-$DIFF_MULTI}"
          if [ -z "$DIFF_JSON" ]; then
            echo "comment=## ðŸ” CDK Diff\n\nâš ï¸ No diff results" >> $GITHUB_OUTPUT
            echo 'slack_blocks=[]' >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CONTEXT_JSON=$(jq -nc \
            --arg repo "$REPO" \
            --arg runUrl "$RUN_URL" \
            --arg prUrl "$PR_URL" \
            --arg prNum "$PR_NUM" \
            --argjson isDeployment false \
            '{repo: $repo, runUrl: $runUrl, prUrl: $prUrl, prNum: $prNum, isDeployment: $isDeployment}')
          
          FORMATTED=$(node _shared/.github/scripts/format-cdk-diff.js "$DIFF_JSON" "$CONTEXT_JSON")
          
          MARKDOWN=$(echo "$FORMATTED" | jq -r '.markdown')
          SLACK_BLOCKS=$(echo "$FORMATTED" | jq -c '.slack_blocks')
          
          echo "comment<<COMMENT_EOF" >> $GITHUB_OUTPUT
          echo "$MARKDOWN" >> $GITHUB_OUTPUT
          echo "COMMENT_EOF" >> $GITHUB_OUTPUT
          
          echo "slack_blocks=$SLACK_BLOCKS" >> $GITHUB_OUTPUT

      - name: Estimate cost impact
        if: inputs.enable-cost-estimate
        id: cost
        env:
          DIFF_JSON: ${{ needs.diff-single.outputs.result || needs.aggregate.outputs.combined }}
          PRICING_REGION: ${{ inputs.aws-region }}
        run: |
          RESULT=$(node _shared/.github/scripts/estimate-cost.js "$DIFF_JSON" "_shared/.github/pricing/resource-map.json" "$PRICING_REGION")
          COST_MD=$(echo "$RESULT" | jq -r '.markdown // empty')
          
          echo "cost_comment<<COST_EOF" >> $GITHUB_OUTPUT
          echo "$COST_MD" >> $GITHUB_OUTPUT
          echo "COST_EOF" >> $GITHUB_OUTPUT

      - name: Post PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: cdk-diff
          number: ${{ inputs.pr-number || github.event.pull_request.number }}
          message: |
            ${{ steps.format.outputs.comment }}
            ${{ steps.cost.outputs.cost_comment || '' }}

      - name: Check Slack label
        id: check-label
        env:
          SLACK_WEBHOOK: ${{ secrets.slack-webhook-url }}
        uses: actions/github-script@v7
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) { core.setOutput('notify', 'false'); return; }
            const prNum = ${{ inputs.pr-number || github.event.pull_request.number || 0 }};
            if (!prNum) { core.setOutput('notify', 'false'); return; }
            const { data: pr } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum });
            core.setOutput('notify', pr.labels.some(l => l.name === '${{ inputs.slack-notify-label }}') ? 'true' : 'false');

      - name: Send Slack
        if: steps.check-label.outputs.notify == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack-webhook-url }}
        run: |
          PAYLOAD=$(jq -nc --argjson blocks '${{ steps.format.outputs.slack_blocks }}' '{blocks: $blocks}')
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL"
