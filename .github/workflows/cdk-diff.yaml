# =============================================================================
# CDK DIFF WORKFLOW (using @aws-cdk/toolkit-lib)
# =============================================================================
# Uses the CDK Toolkit Library for structured, reliable diff output.
# =============================================================================

name: CDK Diff

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory for CDK commands'
        required: false
        type: string
        default: '.'
      python-version:
        description: 'Python version (for Python CDK apps)'
        required: false
        type: string
        default: ''
      node-version:
        description: 'Node.js version (18+ required)'
        required: false
        type: string
        default: '20'
      install-command:
        description: 'Command to install dependencies'
        required: false
        type: string
        default: 'npm ci'
      aws-region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
      aws-role-arn:
        description: 'AWS IAM role ARN (single account mode)'
        required: false
        type: string
        default: ''
      aws-role-arns:
        description: 'JSON map of account IDs to role ARNs (multi-account)'
        required: false
        type: string
        default: ''
      stacks:
        description: 'Space-separated stack names (single account)'
        required: false
        type: string
        default: ''
      stacks-per-account:
        description: 'JSON map of account IDs to stack lists (multi-account)'
        required: false
        type: string
        default: ''
      enable-drift-detection:
        description: 'Run drift detection'
        required: false
        type: boolean
        default: true
      account-names:
        description: 'JSON map of account IDs to friendly names'
        required: false
        type: string
        default: '{}'
      pr-number:
        description: 'Pull request number'
        required: false
        type: number
        default: 0
      slack-notify-label:
        description: 'PR label that triggers Slack notification'
        required: false
        type: string
        default: 'slack-notify'
      slack-channel-name:
        description: 'Slack channel name'
        required: false
        type: string
        default: 'devops'
    secrets:
      slack-webhook-url:
        description: 'Slack webhook URL'
        required: false

jobs:
  diff:
    name: CDK Diff
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        if: inputs.python-version != ''
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install dependencies
        run: ${{ inputs.install-command }}

      - name: Install CDK tools
        run: |
          npm install -g aws-cdk
          npm install -g @aws-cdk/toolkit-lib typescript ts-node @types/node

      # =====================================================================
      # SINGLE ACCOUNT MODE
      # =====================================================================
      - name: Configure AWS credentials (single account)
        if: inputs.aws-role-arn != '' && inputs.aws-role-arns == ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      - name: Run CDK Diff (single account)
        if: inputs.aws-role-arn != '' && inputs.aws-role-arns == ''
        id: single-diff
        env:
          STACKS: ${{ inputs.stacks }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
        run: |
          # Synth
          npx cdk synth --quiet --output cdk.out
          
          # Create temp project for toolkit
          mkdir -p /tmp/cdk-diff-runner
          cd /tmp/cdk-diff-runner
          
          cat > package.json << 'PKG'
          {"type":"module","dependencies":{"@aws-cdk/toolkit-lib":"*"}}
          PKG
          
          npm install --silent
          
          cat > run.js << 'SCRIPT'
          import { Toolkit, StackSelectionStrategy } from '@aws-cdk/toolkit-lib';
          
          const stacks = (process.env.STACKS || '').split(' ').filter(Boolean);
          const enableDrift = process.env.ENABLE_DRIFT === 'true';
          const assemblyDir = process.env.CDK_OUT;
          
          async function main() {
            const output = { success: false, stacks: [], error: '' };
            
            try {
              const toolkit = new Toolkit({
                ioHost: {
                  notify: async () => {},
                  requestResponse: async (msg) => msg.defaultResponse,
                },
              });
              
              const cx = await toolkit.fromAssemblyDirectory(assemblyDir);
              const selector = stacks.length
                ? { strategy: StackSelectionStrategy.PATTERN_MUST_MATCH, patterns: stacks }
                : { strategy: StackSelectionStrategy.ALL_STACKS };
              
              const diffResults = await toolkit.diff(cx, { stacks: selector });
              
              for (const [name, diff] of Object.entries(diffResults)) {
                const result = { stackName: name, hasDiff: false, resources: [] };
                
                for (const [logicalId, resDiff] of Object.entries(diff.resources?.diffs || {})) {
                  const type = resDiff.resourceTypes?.newType || resDiff.resourceTypes?.oldType || 'Unknown';
                  const action = resDiff.isAddition ? 'ADD' : resDiff.isRemoval ? 'REMOVE' : 'UPDATE';
                  
                  const properties = Object.entries(resDiff.propertyDiffs || {})
                    .filter(([_, p]) => p.isDifferent)
                    .map(([propName, p]) => ({ name: propName, impact: p.changeImpact || 'UNKNOWN' }));
                  
                  result.resources.push({ logicalId, type, action, properties });
                  result.hasDiff = true;
                }
                
                output.stacks.push(result);
              }
              
              // Drift detection
              if (enableDrift) {
                try {
                  const driftResults = await toolkit.drift(cx, { stacks: selector });
                  for (const [name, driftInfo] of Object.entries(driftResults)) {
                    const stack = output.stacks.find(s => s.stackName === name);
                    if (stack) {
                      stack.drift = {
                        status: (driftInfo.numResourcesWithDrift || 0) > 0 ? 'DRIFTED' : 'IN_SYNC',
                        count: driftInfo.numResourcesWithDrift || 0
                      };
                    }
                  }
                } catch (e) {
                  // Drift failed, skip
                }
              }
              
              output.success = true;
            } catch (e) {
              output.error = e.message || String(e);
            }
            
            console.log(JSON.stringify(output));
          }
          
          main();
          SCRIPT
          
          cd ${{ github.workspace }}/${{ inputs.working-directory }}
          CDK_OUT="$(pwd)/cdk.out" node /tmp/cdk-diff-runner/run.js > /tmp/diff-output.json 2>/tmp/diff-stderr.txt || true
          
          if [ -s /tmp/diff-output.json ]; then
            RESULT=$(cat /tmp/diff-output.json | tail -1)
          else
            STDERR=$(cat /tmp/diff-stderr.txt 2>/dev/null || echo "unknown error")
            RESULT='{"success":false,"error":"'"${STDERR//\"/\\\"}"'","stacks":[]}'
          fi
          
          echo "diff_result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # =====================================================================
      # MULTI-ACCOUNT MODE  
      # =====================================================================
      - name: Setup toolkit runner (multi-account)
        if: inputs.aws-role-arns != '' && inputs.stacks-per-account != ''
        run: |
          mkdir -p /tmp/cdk-diff-runner
          cd /tmp/cdk-diff-runner
          echo '{"type":"module","dependencies":{"@aws-cdk/toolkit-lib":"*"}}' > package.json
          npm install --silent
          
          cat > run.js << 'SCRIPT'
          import { Toolkit, StackSelectionStrategy } from '@aws-cdk/toolkit-lib';
          
          const stacks = (process.env.STACKS || '').split(' ').filter(Boolean);
          const enableDrift = process.env.ENABLE_DRIFT === 'true';
          const assemblyDir = process.env.CDK_OUT;
          
          async function main() {
            const output = { success: false, stacks: [], error: '' };
            try {
              const toolkit = new Toolkit({
                ioHost: { notify: async () => {}, requestResponse: async (msg) => msg.defaultResponse },
              });
              const cx = await toolkit.fromAssemblyDirectory(assemblyDir);
              const selector = stacks.length
                ? { strategy: StackSelectionStrategy.PATTERN_MUST_MATCH, patterns: stacks }
                : { strategy: StackSelectionStrategy.ALL_STACKS };
              const diffResults = await toolkit.diff(cx, { stacks: selector });
              
              for (const [name, diff] of Object.entries(diffResults)) {
                const result = { stackName: name, hasDiff: false, resources: [] };
                for (const [logicalId, resDiff] of Object.entries(diff.resources?.diffs || {})) {
                  const type = resDiff.resourceTypes?.newType || resDiff.resourceTypes?.oldType || 'Unknown';
                  const action = resDiff.isAddition ? 'ADD' : resDiff.isRemoval ? 'REMOVE' : 'UPDATE';
                  const properties = Object.entries(resDiff.propertyDiffs || {})
                    .filter(([_, p]) => p.isDifferent)
                    .map(([propName, p]) => ({ name: propName, impact: p.changeImpact || 'UNKNOWN' }));
                  result.resources.push({ logicalId, type, action, properties });
                  result.hasDiff = true;
                }
                if (enableDrift) {
                  try {
                    const driftResults = await toolkit.drift(cx, { stacks: { strategy: StackSelectionStrategy.PATTERN_MUST_MATCH, patterns: [name] } });
                    const driftInfo = driftResults[name];
                    result.drift = { status: (driftInfo?.numResourcesWithDrift || 0) > 0 ? 'DRIFTED' : 'IN_SYNC', count: driftInfo?.numResourcesWithDrift || 0 };
                  } catch (e) {}
                }
                output.stacks.push(result);
              }
              output.success = true;
            } catch (e) { output.error = e.message || String(e); }
            console.log(JSON.stringify(output));
          }
          main();
          SCRIPT

      - name: Run CDK Diff (multi-account)
        if: inputs.aws-role-arns != '' && inputs.stacks-per-account != ''
        id: multi-diff
        env:
          AWS_ROLE_ARNS: ${{ inputs.aws-role-arns }}
          STACKS_PER_ACCOUNT: ${{ inputs.stacks-per-account }}
          AWS_REGION: ${{ inputs.aws-region }}
          ENABLE_DRIFT: ${{ inputs.enable-drift-detection }}
        run: |
          ALL_STACKS='[]'
          
          for ACCOUNT_ID in $(echo "$AWS_ROLE_ARNS" | jq -r 'keys[]'); do
            ROLE_ARN=$(echo "$AWS_ROLE_ARNS" | jq -r --arg acc "$ACCOUNT_ID" '.[$acc]')
            STACKS=$(echo "$STACKS_PER_ACCOUNT" | jq -r --arg acc "$ACCOUNT_ID" '.[$acc] // ""')
            
            [ -z "$STACKS" ] && continue
            
            echo "=== Account $ACCOUNT_ID ==="
            
            # Assume role
            CREDS=$(aws sts assume-role --role-arn "$ROLE_ARN" --role-session-name "cdk-diff" --duration-seconds 3600 --output json)
            export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r '.Credentials.AccessKeyId')
            export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r '.Credentials.SecretAccessKey')
            export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r '.Credentials.SessionToken')
            export CDK_DEFAULT_ACCOUNT="$ACCOUNT_ID"
            export CDK_DEFAULT_REGION="$AWS_REGION"
            
            # Synth
            rm -rf cdk.out
            npx cdk synth --quiet --output cdk.out
            
            STACKS="$STACKS" CDK_OUT="$(pwd)/cdk.out" node /tmp/cdk-diff-runner/run.js > /tmp/account-diff.json 2>/tmp/diff-stderr.txt || true
            
            if [ -s /tmp/account-diff.json ]; then
              ACCOUNT_RESULT=$(cat /tmp/account-diff.json | tail -1)
              ALL_STACKS=$(echo "$ALL_STACKS" | jq --argjson new "$(echo "$ACCOUNT_RESULT" | jq '.stacks')" '. + $new')
            fi
            
            unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
          done
          
          FINAL='{"success":true,"stacks":'$ALL_STACKS'}'
          
          echo "diff_result<<EOF" >> $GITHUB_OUTPUT
          echo "$FINAL" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # =====================================================================
      # GENERATE AND POST PR COMMENT
      # =====================================================================
      - name: Generate PR Comment
        id: comment
        uses: actions/github-script@v7
        env:
          DIFF_RESULT: ${{ steps.single-diff.outputs.diff_result || steps.multi-diff.outputs.diff_result }}
          ACCOUNT_NAMES: ${{ inputs.account-names }}
        with:
          script: |
            const raw = process.env.DIFF_RESULT;
            if (!raw) {
              core.setOutput('comment', '## üîç CDK Diff\n\n‚ö†Ô∏è No diff results');
              return;
            }
            
            let data;
            try {
              data = JSON.parse(raw);
            } catch (e) {
              core.setOutput('comment', `## üîç CDK Diff\n\n‚ùå Parse error: ${e.message}\n\n\`\`\`\n${raw.slice(0, 500)}\n\`\`\``);
              return;
            }
            
            const accountNames = JSON.parse(process.env.ACCOUNT_NAMES || '{}');
            const getEnv = (name) => name.toLowerCase().includes('prod') ? 'production' : name.toLowerCase().includes('staging') ? 'staging' : 'dev';
            
            let md = '## üîç CDK Diff Results\n\n';
            
            if (!data.success) {
              md += `‚ùå **Error:** ${data.error}\n\n`;
            }
            
            const changed = data.stacks.filter(s => s.hasDiff);
            const unchanged = data.stacks.filter(s => !s.hasDiff);
            
            // Summary
            const adds = data.stacks.reduce((n, s) => n + s.resources.filter(r => r.action === 'ADD').length, 0);
            const updates = data.stacks.reduce((n, s) => n + s.resources.filter(r => r.action === 'UPDATE').length, 0);
            const removes = data.stacks.reduce((n, s) => n + s.resources.filter(r => r.action === 'REMOVE').length, 0);
            
            if (changed.length === 0) {
              md += '‚úÖ **No infrastructure changes**\n\n';
            } else {
              const parts = [];
              if (adds) parts.push(`‚ûï ${adds} add`);
              if (updates) parts.push(`üîÑ ${updates} update`);
              if (removes) parts.push(`‚ûñ ${removes} remove`);
              md += `üìä **Summary:** ${parts.join(' | ')}\n\n`;
            }
            
            // Changed stacks
            for (const stack of changed) {
              md += `### üì¶ ${stack.stackName} _(${getEnv(stack.stackName)})_\n\n`;
              md += '| Resource | Type | Action | Properties |\n|----------|------|--------|------------|\n';
              
              for (const res of stack.resources) {
                const icon = res.action === 'ADD' ? 'üü¢' : res.action === 'REMOVE' ? 'üî¥' : 'üü°';
                const props = res.properties.length 
                  ? res.properties.map(p => `\`${p.name}\`${p.impact === 'WILL_REPLACE' ? ' ‚ö†Ô∏è' : ''}`).join(', ')
                  : res.action === 'ADD' ? '_(new)_' : res.action === 'REMOVE' ? '_(deleted)_' : '-';
                
                md += `| \`${res.logicalId}\` | ${res.type} | ${icon} ${res.action} | ${props} |\n`;
              }
              
              if (stack.drift) {
                md += `\n**Drift:** ${stack.drift.status === 'DRIFTED' ? `‚ö†Ô∏è ${stack.drift.count} drifted` : '‚úÖ IN_SYNC'}\n`;
              }
              md += '\n';
            }
            
            // Unchanged stacks
            if (unchanged.length > 0) {
              md += `<details>\n<summary>‚úÖ Unchanged (${unchanged.length})</summary>\n\n`;
              for (const s of unchanged) md += `- ${s.stackName}\n`;
              md += '\n</details>\n\n';
            }
            
            md += `---\n_Generated at ${new Date().toISOString()}_`;
            
            core.setOutput('comment', md);

      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: cdk-diff
          number: ${{ inputs.pr-number || github.event.pull_request.number }}
          message: ${{ steps.comment.outputs.comment }}

      # =====================================================================
      # SLACK (Optional)
      # =====================================================================
      - name: Check Slack label
        id: check-label
        env:
          SLACK_WEBHOOK: ${{ secrets.slack-webhook-url }}
        uses: actions/github-script@v7
        with:
          script: |
            if (!process.env.SLACK_WEBHOOK) { core.setOutput('notify', 'false'); return; }
            const prNum = ${{ inputs.pr-number || github.event.pull_request.number || 0 }};
            if (!prNum) { core.setOutput('notify', 'false'); return; }
            const { data: pr } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNum });
            core.setOutput('notify', pr.labels.some(l => l.name === '${{ inputs.slack-notify-label }}') ? 'true' : 'false');

      - name: Send Slack
        if: steps.check-label.outputs.notify == 'true'
        uses: slackapi/slack-github-action@v1.25.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack-webhook-url }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {"blocks":[{"type":"header","text":{"type":"plain_text","text":"üîç CDK Diff Results"}},{"type":"section","fields":[{"type":"mrkdwn","text":"*Repo:* ${{ github.repository }}"},{"type":"mrkdwn","text":"*PR:* <${{ github.event.pull_request.html_url || format('https://github.com/{0}/pull/{1}', github.repository, inputs.pr-number) }}|#${{ inputs.pr-number || github.event.pull_request.number }}>"}]},{"type":"section","text":{"type":"mrkdwn","text":"See PR comment for details."}}]}
