# =============================================================================
# CDK DEPLOY WORKFLOW
# =============================================================================
# This reusable workflow performs CDK deploy operations and sends nicely
# formatted Slack notifications with change summaries.
#
# FEATURES:
#   - Runs `cdk deploy` on specified stacks
#   - Parses diff output to show clean change summaries
#   - Sends formatted Slack notifications (success/failure)
#   - Supports dry-run mode for testing
# =============================================================================

name: CDK Deploy

on:
  workflow_call:
    inputs:
      # -----------------------------------------------------------------------
      # Build Environment Configuration
      # -----------------------------------------------------------------------
      working-directory:
        description: 'Working directory for CDK commands'
        required: false
        type: string
        default: '.'

      python-version:
        description: 'Python version (for Python CDK apps)'
        required: false
        type: string
        default: ''

      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'

      install-command:
        description: 'Command to install dependencies'
        required: false
        type: string
        default: 'npm ci'

      # -----------------------------------------------------------------------
      # AWS Configuration
      # -----------------------------------------------------------------------
      aws-region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'

      aws-role-arn:
        description: 'AWS IAM role ARN to assume'
        required: true
        type: string

      # -----------------------------------------------------------------------
      # CDK Deploy Configuration
      # -----------------------------------------------------------------------
      stacks:
        description: 'Space-separated list of stack names to deploy'
        required: true
        type: string

      require-approval:
        description: 'CDK approval level (never, any-change, broadening)'
        required: false
        type: string
        default: 'never'

      dry-run:
        description: 'If true, only run diff without deploying'
        required: false
        type: boolean
        default: false

      # -----------------------------------------------------------------------
      # Slack Configuration
      # -----------------------------------------------------------------------
      slack-channel-name:
        description: 'Slack channel name (for display purposes)'
        required: false
        type: string
        default: 'devops'

    secrets:
      slack-webhook-url:
        description: 'Slack webhook URL for notifications'
        required: false

jobs:
  deploy:
    name: CDK Deploy
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      # =======================================================================
      # SETUP
      # =======================================================================
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: ${{ github.job_workflow_sha }}
          sparse-checkout: .github/scripts
          path: _shared

      - name: Setup Python
        if: inputs.python-version != ''
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install dependencies
        run: ${{ inputs.install-command }}

      - name: Install AWS CDK CLI
        run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          role-duration-seconds: 3600
          aws-region: ${{ inputs.aws-region }}

      # =======================================================================
      # CDK SYNTH & DIFF (using toolkit-lib for structured output)
      # =======================================================================
      - name: CDK Synth
        run: npx cdk synth --quiet --output cdk.out

      - name: Run CDK diff
        id: diff
        env:
          STACKS: ${{ inputs.stacks }}
          ENABLE_DRIFT: 'false'
          WORK_DIR: ${{ github.workspace }}/${{ inputs.working-directory }}
          SCRIPT_PATH: ${{ github.workspace }}/_shared/.github/scripts/run-cdk-diff.mjs
        run: bash ${{ github.workspace }}/_shared/.github/scripts/run-cdk-diff-wrapper.sh

      - name: Save diff result for Slack
        run: echo '${{ steps.diff.outputs.result }}' > diff_result.json

      # =======================================================================
      # CDK DEPLOY
      # =======================================================================
      - name: Deploy stacks
        id: deploy
        if: inputs.dry-run != true
        env:
          STACKS: ${{ inputs.stacks }}
        run: |
          echo "=== Deploying stacks ==="
          echo "$STACKS"
          echo ""
          npx cdk deploy $STACKS --require-approval ${{ inputs.require-approval }}

      - name: Skip deploy (dry run)
        if: inputs.dry-run == true
        run: |
          echo "üîç DRY RUN MODE - Skipping actual deployment"
          echo "Would have deployed: ${{ inputs.stacks }}"

      # =======================================================================
      # SLACK NOTIFICATION (using shared formatter)
      # =======================================================================
      - name: Format and send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack-webhook-url }}
          JOB_STATUS: ${{ job.status }}
          DRY_RUN: ${{ inputs.dry-run }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SCRIPT_PATH: ${{ github.workspace }}/_shared/.github/scripts/format-cdk-diff.js
        run: bash ${{ github.workspace }}/_shared/.github/scripts/send-deploy-slack.sh
