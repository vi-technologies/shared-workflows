# =============================================================================
# SHARED DOCKER BUILD & PUSH WORKFLOW
# =============================================================================
# This reusable workflow builds and pushes Docker images for microservices.
#
# CONVENTION:
#   - A top-level folder (default: "jobs") contains subfolders
#   - Each subfolder is a microservice with its own Dockerfile
#   - Caller provides explicit image names via services-config JSON
#   - Auto-detects changed folders and only builds what changed
#   - Tags images with both :latest and :$COMMIT_SHA
#
# USAGE:
#   jobs:
#     build:
#       uses: vi-technologies/shared-workflows/.github/workflows/docker-build.yaml@main
#       with:
#         services-folder: jobs
#         ecr-services-repo-names: |
#           {
#             "bronze": { "staging": "staging_engage_bronze_etl", "production": "production_engage_bronze_etl" },
#             "silver": { "staging": "staging_engage_silver_etl", "production": "production_engage_silver_etl" }
#           }
#       secrets:
#         aws-account-id-staging: ${{ secrets.AWS_ACCOUNTID_STAGING }}
#         aws-account-id-prod: ${{ secrets.AWS_ACCOUNTID_PROD }}
# =============================================================================

name: Docker Build & Push

on:
  workflow_call:
    inputs:
      services-folder:
        description: 'Top-level folder containing microservice subfolders (each with a Dockerfile)'
        required: false
        type: string
        default: 'jobs'
      ecr-services-repo-names:
        description: 'JSON mapping of service names to ECR repo names: {"service": {"staging": "repo_name", "production": "repo_name"}}'
        required: true
        type: string
      aws-region:
        description: 'AWS region for ECR'
        required: false
        type: string
        default: 'us-east-1'
      environment:
        description: 'Target environment (staging/production). If not set, auto-detects from trigger.'
        required: false
        type: string
        default: ''
      build-all:
        description: 'Build all services regardless of changes'
        required: false
        type: boolean
        default: false
      shared-paths:
        description: 'Space-separated paths that, if changed, trigger ALL services to rebuild (e.g., "utils/ shared/")'
        required: false
        type: string
        default: ''
    secrets:
      aws-account-id-staging:
        description: 'AWS Account ID for staging environment'
        required: false
      aws-account-id-prod:
        description: 'AWS Account ID for production environment'
        required: false
    outputs:
      services-built:
        description: 'Space-separated list of services that were built'
        value: ${{ jobs.build.outputs.services_built }}
      has-changes:
        description: 'Whether any services had changes'
        value: ${{ jobs.detect.outputs.has_changes }}

jobs:
  # ===========================================================================
  # JOB 1: DETECT CHANGED SERVICES
  # ===========================================================================
  detect:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      services_json: ${{ steps.detect.outputs.services_json }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      changed_files: ${{ steps.detect.outputs.changed_files }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: .github/scripts
          path: _shared

      - name: Detect changed service folders
        id: detect
        env:
          SERVICES_FOLDER: ${{ inputs.services-folder }}
          SERVICES_CONFIG: ${{ inputs.ecr-services-repo-names }}
          BUILD_ALL: ${{ inputs.build-all }}
          SHARED_PATHS: ${{ inputs.shared-paths }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PUSH_BEFORE_SHA: ${{ github.event.before }}
          PUSH_SHA: ${{ github.sha }}
        run: bash _shared/.github/scripts/detect-docker-changes.sh

  # ===========================================================================
  # JOB 2: POST PR COMMENT (for pull_request events)
  # ===========================================================================
  pr-comment:
    name: PR Comment
    needs: detect
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: .github/scripts
          path: _shared

      - name: Build PR comment
        id: comment
        uses: actions/github-script@v7
        env:
          SERVICES: ${{ needs.detect.outputs.services }}
          SERVICES_CONFIG: ${{ inputs.ecr-services-repo-names }}
          CHANGED_FILES: ${{ needs.detect.outputs.changed_files }}
          SERVICES_FOLDER: ${{ inputs.services-folder }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
          SHARED_PATHS: ${{ inputs.shared-paths }}
        with:
          script: |
            const fs = require('fs');
            const scriptContent = fs.readFileSync('_shared/.github/scripts/format-docker-comment.js', 'utf8');
            eval(scriptContent);

      - name: Post sticky comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: docker-build-preview
          message: ${{ steps.comment.outputs.body }}

  # ===========================================================================
  # JOB 3: BUILD AND PUSH IMAGES (using docker/build-push-action)
  # ===========================================================================
  build:
    name: Build & Push
    needs: detect
    if: needs.detect.outputs.has_changes == 'true' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      services_built: ${{ steps.summary.outputs.services_built }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect.outputs.services_json) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          repository: vi-technologies/shared-workflows
          ref: VE-7478-discovery-use-ai-to-calculate-costs-changes-in-pr
          sparse-checkout: .github/scripts
          path: _shared

      - name: Determine environment and account
        id: env
        env:
          INPUT_ENV: ${{ inputs.environment }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF: ${{ github.ref }}
          AWS_ACCOUNT_STAGING: ${{ secrets.aws-account-id-staging }}
          AWS_ACCOUNT_PROD: ${{ secrets.aws-account-id-prod }}
        run: bash _shared/.github/scripts/resolve-docker-env.sh

      - name: Get image name from config
        id: image
        env:
          SERVICE: ${{ matrix.service }}
          TARGET_ENV: ${{ steps.env.outputs.TARGET_ENV }}
          AWS_ACCOUNT_ID: ${{ steps.env.outputs.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ inputs.aws-region }}
          SERVICES_CONFIG: ${{ inputs.ecr-services-repo-names }}
        run: bash _shared/.github/scripts/resolve-ecr-image.sh

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.env.outputs.AWS_ACCOUNT_ID }}:role/GithubActionsAppRole
          aws-region: ${{ inputs.aws-region }}
          audience: sts.amazonaws.com

      - name: Verify ECR repository exists
        env:
          IMAGE_NAME: ${{ steps.image.outputs.IMAGE_NAME }}
          AWS_REGION: ${{ inputs.aws-region }}
        run: bash _shared/.github/scripts/verify-ecr-repo.sh

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.FULL_IMAGE }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.services-folder }}/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Output built service
        id: summary
        run: |
          echo "âœ… Successfully pushed: ${{ steps.image.outputs.FULL_IMAGE }}"
          echo "   Tags: ${{ steps.meta.outputs.tags }}"
          echo "services_built=${{ matrix.service }}" >> $GITHUB_OUTPUT
